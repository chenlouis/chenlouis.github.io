
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>项目框架练习 | louis.chen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="louis.chen">
    

    
    <meta name="description" content="这是目前实现的效果,希望通过这个项目,去掌握项目框架的一般模式。Just for personnal exercise。详见笔记。">
<meta property="og:type" content="article">
<meta property="og:title" content="项目框架练习">
<meta property="og:url" content="http://chenfuduo.me/2015/10/03/项目框架练习/index.html">
<meta property="og:site_name" content="louis.chen">
<meta property="og:description" content="这是目前实现的效果,希望通过这个项目,去掌握项目框架的一般模式。Just for personnal exercise。详见笔记。">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/circleimageview1005.gif">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/hibirad.gif">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/mainframe.gif">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/frame1002.gif">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/uiframe.gif">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/subjectui.gif">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/gameandappui.gif">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/errormoreloading.gif">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/loadingmore.gif">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/framework1005.gif">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/circleimageview1005.gif">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/微信截图_20151005225006.png">
<meta property="og:image" content="http://7xljei.com1.z0.glb.clouddn.com/circleimageview1005.gif">
<meta property="og:updated_time" content="2015-10-05T15:00:09.441Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="项目框架练习">
<meta name="twitter:description" content="这是目前实现的效果,希望通过这个项目,去掌握项目框架的一般模式。Just for personnal exercise。详见笔记。">

    
    <link rel="alternative" href="/atom.xml" title="louis.chen" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="louis.chen" title="louis.chen"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="louis.chen">louis.chen</a></h1>
				<h2 class="blog-motto">纸上得来终觉浅,绝知此事要躬行。</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/project">项目</a></li>
					
						<li><a href="/about">资源</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:chenfuduo.me">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/03/项目框架练习/" title="项目框架练习" itemprop="url">项目框架练习</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="louis.chen" target="_blank" itemprop="author">louis.chen</a>
		
  <p class="article-time">
    <time datetime="2015-10-02T17:04:46.000Z" itemprop="datePublished"> 发表于 2015-10-03</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-01上午"><span class="toc-number">1.</span> <span class="toc-text">2015.10.01上午</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境搭建"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ActionBar的显示"><span class="toc-number">1.2.</span> <span class="toc-text">ActionBar的显示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ActionBar的搜索功能"><span class="toc-number">1.3.</span> <span class="toc-text">ActionBar的搜索功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ActionBar的返回功能"><span class="toc-number">1.4.</span> <span class="toc-text">ActionBar的返回功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TabLayout,DrawerLayout,NavigationView,Toolbar搭建程序主界面"><span class="toc-number">1.5.</span> <span class="toc-text">TabLayout,DrawerLayout,NavigationView,Toolbar搭建程序主界面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-01晚上"><span class="toc-number">2.</span> <span class="toc-text">2015.10.01晚上</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#主界面"><span class="toc-number">2.1.</span> <span class="toc-text">主界面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#抽取BaseActivity"><span class="toc-number">2.2.</span> <span class="toc-text">抽取BaseActivity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FragmentFactory"><span class="toc-number">2.3.</span> <span class="toc-text">FragmentFactory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#广播退出Activity"><span class="toc-number">2.4.</span> <span class="toc-text">广播退出Activity</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-02上午"><span class="toc-number">3.</span> <span class="toc-text">2015.10.02上午</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#显示界面的架子"><span class="toc-number">3.1.</span> <span class="toc-text">显示界面的架子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五种状态"><span class="toc-number">3.2.</span> <span class="toc-text">五种状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#复用FrameLayout的问题"><span class="toc-number">3.3.</span> <span class="toc-text">复用FrameLayout的问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-02下午"><span class="toc-number">4.</span> <span class="toc-text">2015.10.02下午</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#抽取到BaseFragment中"><span class="toc-number">4.1.</span> <span class="toc-text">抽取到BaseFragment中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#抽取到LoadingPage"><span class="toc-number">4.2.</span> <span class="toc-text">抽取到LoadingPage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#线程池原理"><span class="toc-number">4.3.</span> <span class="toc-text">线程池原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-02晚上"><span class="toc-number">5.</span> <span class="toc-text">2015.10.02晚上</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#请求服务器的框架"><span class="toc-number">5.1.</span> <span class="toc-text">请求服务器的框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xUtils网络请求导致的错误"><span class="toc-number">5.2.</span> <span class="toc-text">xUtils网络请求导致的错误</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#联网请求数据"><span class="toc-number">5.3.</span> <span class="toc-text">联网请求数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#保存缓存到本地"><span class="toc-number">5.4.</span> <span class="toc-text">保存缓存到本地</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#读取本地缓存"><span class="toc-number">5.5.</span> <span class="toc-text">读取本地缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#json解析"><span class="toc-number">5.6.</span> <span class="toc-text">json解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#布局的搭建"><span class="toc-number">5.7.</span> <span class="toc-text">布局的搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载界面"><span class="toc-number">5.8.</span> <span class="toc-text">加载界面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-03上午"><span class="toc-number">6.</span> <span class="toc-text">2015.10.03上午</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#抽取BaseProtocol"><span class="toc-number">6.1.</span> <span class="toc-text">抽取BaseProtocol</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#专题界面完成"><span class="toc-number">6.2.</span> <span class="toc-text">专题界面完成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BaseListView"><span class="toc-number">6.3.</span> <span class="toc-text">BaseListView</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-03下午"><span class="toc-number">7.</span> <span class="toc-text">2015.10.03下午</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#抽取Adapter和ViewHolder"><span class="toc-number">7.1.</span> <span class="toc-text">抽取Adapter和ViewHolder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#游戏和应用界面"><span class="toc-number">7.2.</span> <span class="toc-text">游戏和应用界面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-03晚上"><span class="toc-number">8.</span> <span class="toc-text">2015.10.03晚上</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MoreViewHolder(加载更多)"><span class="toc-number">8.1.</span> <span class="toc-text">MoreViewHolder(加载更多)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ListView多类型复用"><span class="toc-number">8.2.</span> <span class="toc-text">ListView多类型复用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载更多的业务逻辑"><span class="toc-number">8.3.</span> <span class="toc-text">加载更多的业务逻辑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载更多"><span class="toc-number">8.4.</span> <span class="toc-text">加载更多</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-05晚上"><span class="toc-number">9.</span> <span class="toc-text">2015.10.05晚上</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#框架搭建复习"><span class="toc-number">9.1.</span> <span class="toc-text">框架搭建复习</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#首页展示图片"><span class="toc-number">9.2.</span> <span class="toc-text">首页展示图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#轮播图的无线循环"><span class="toc-number">9.3.</span> <span class="toc-text">轮播图的无线循环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#条目点击事件"><span class="toc-number">9.4.</span> <span class="toc-text">条目点击事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DetailActivity数据解析"><span class="toc-number">9.5.</span> <span class="toc-text">DetailActivity数据解析</span></a></li></ol></li></ol>
		
		</div>
		
		<p><img src="http://7xljei.com1.z0.glb.clouddn.com/circleimageview1005.gif" alt="效果图"></p>
<p>这是目前实现的效果,希望通过这个项目,去掌握项目框架的一般模式。Just for personnal exercise。<br>详见笔记。</p>
<a id="more"></a>
<h1 id="2015-10-01上午">2015.10.01上午</h1><h2 id="环境搭建">环境搭建</h2><p>将WebInfo导入到SD卡根目录,启动WebServer服务，模拟服务器。</p>
<h2 id="ActionBar的显示">ActionBar的显示</h2><h2 id="ActionBar的搜索功能">ActionBar的搜索功能</h2><p>配置下<code>/res/menu/menu_main.xml</code>文件：<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">menu</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">xmlns:app</span>=<span class="value">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="line">    <span class="attribute">xmlns:tools</span>=<span class="value">"http://schemas.android.com/tools"</span></span><br><span class="line">    <span class="attribute">tools:context</span>=<span class="value">".MainActivity"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/action_settings"</span></span><br><span class="line">        <span class="attribute">android:orderInCategory</span>=<span class="value">"100"</span></span><br><span class="line">        <span class="attribute">android:title</span>=<span class="value">"@string/action_settings"</span></span><br><span class="line">        <span class="attribute">app:showAsAction</span>=<span class="value">"never"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span></span><br><span class="line">        <span class="attribute">android:icon</span>=<span class="value">"@drawable/ic_action_search"</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/action_search"</span></span><br><span class="line">        <span class="attribute">android:orderInCategory</span>=<span class="value">"100"</span></span><br><span class="line">        <span class="attribute">android:title</span>=<span class="value">"@string/action_search"</span></span><br><span class="line">        <span class="attribute">app:showAsAction</span>=<span class="value">"ifRoom"</span></span><br><span class="line">        <span class="attribute">app:actionViewClass</span>=<span class="value">"android.support.v7.widget.SearchView"</span></span><br><span class="line">        /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">menu</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>接着在Activity中,实现<code>SearchView.OnQueryTextListener</code>接口,并实现该接口的两个方法：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onQueryTextSubmit</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>,s,Toast.LENGTH_SHORT).show();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onQueryTextChange</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>,s,Toast.LENGTH_SHORT).show();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>接着找到<code>SearchView</code>:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">        getMenuInflater().inflate(R.menu.menu_main, menu);</span><br><span class="line">        SearchView searchView = (SearchView) menu.findItem(R.id.action_search).getActionView();</span><br><span class="line">        searchView.setOnQueryTextListener(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = item.getItemId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id == R.id.action_settings) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(id == R.id.action_search)&#123;</span><br><span class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>,<span class="string">"搜搜"</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="ActionBar的返回功能">ActionBar的返回功能</h2><p>ActionBar的返回功能有两种处理方式。假如现在有两个Activity,一个是MainActivity，一个是TestActvity,现在从MainActivity点击跳转到<br>TestActivity,在TestActivity的ActionBar上有返回上一级的图标,点击这个图标,既可以返回到MainActivity。</p>
<p>首先在TestActivity中得到这个图标：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_test);</span><br><span class="line">       ActionBar actionBar = getSupportActionBar();</span><br><span class="line">       actionBar.setDisplayHomeAsUpEnabled(<span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>那么现在这个图标需要响应返回上一级的功能。<br>一种处理方式是这样的：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">        getMenuInflater().inflate(R.menu.menu_test, menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = item.getItemId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id == R.id.action_settings) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(id == android.R.id.home)&#123;</span><br><span class="line">            finish();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这个图标的id就是<code>android.R.id.home</code>。</p>
<p>其二的处理方式是这样的,在清单文件中配置:<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">activity</span></span><br><span class="line">    <span class="attribute">android:name</span>=<span class="value">".TestActivity"</span></span><br><span class="line">    <span class="attribute">android:label</span>=<span class="value">"@string/title_activity_test"</span></span><br><span class="line">    <span class="attribute">android:parentActivityName</span>=<span class="value">".MainActivity"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">meta-data</span></span><br><span class="line">        <span class="attribute">android:name</span>=<span class="value">"android.support.PARENT_ACTIVITY"</span></span><br><span class="line">        <span class="attribute">android:value</span>=<span class="value">".MainActivity"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">meta-data</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">activity</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="TabLayout,DrawerLayout,NavigationView,Toolbar搭建程序主界面">TabLayout,DrawerLayout,NavigationView,Toolbar搭建程序主界面</h2><p><img src="http://7xljei.com1.z0.glb.clouddn.com/hibirad.gif" alt="效果图"></p>
<p>布局：<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">android.support.v4.widget.DrawerLayout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">xmlns:app</span>=<span class="value">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="line">    <span class="attribute">android:id</span>=<span class="value">"@+id/drawer_layout"</span></span><br><span class="line">    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">LinearLayout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">        <span class="attribute">xmlns:app</span>=<span class="value">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">android.support.v7.widget.Toolbar</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/toolbar"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"?attr/actionBarSize"</span></span><br><span class="line">            <span class="attribute">android:background</span>=<span class="value">"?attr/colorPrimary"</span></span><br><span class="line">            <span class="attribute">android:fitsSystemWindows</span>=<span class="value">"true"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">android.support.design.widget.TabLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/tabLayout"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:background</span>=<span class="value">"?attr/colorPrimary"</span></span><br><span class="line">            <span class="attribute">android:scrollbars</span>=<span class="value">"horizontal"</span></span><br><span class="line">            <span class="attribute">app:layout_scrollFlags</span>=<span class="value">"scroll|enterAlways"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">android.support.v4.view.ViewPager</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/viewpager"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:background</span>=<span class="value">"@android:color/white"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">android.support.design.widget.NavigationView</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/nvView"</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"200dp"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:fitsSystemWindows</span>=<span class="value">"true"</span></span><br><span class="line">        <span class="attribute">android:layout_gravity</span>=<span class="value">"start"</span></span><br><span class="line">        <span class="attribute">android:background</span>=<span class="value">"@color/deep_purple_600"</span></span><br><span class="line">        <span class="attribute">app:menu</span>=<span class="value">"@menu/drawer_view"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">android.support.v4.widget.DrawerLayout</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>主界面：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.res.Configuration;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.design.widget.NavigationView;</span><br><span class="line"><span class="keyword">import</span> android.support.design.widget.TabLayout;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.view.GravityCompat;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.view.ViewPager;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.widget.DrawerLayout;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.ActionBar;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.ActionBarDrawerToggle;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.widget.Toolbar;</span><br><span class="line"><span class="keyword">import</span> android.view.Menu;</span><br><span class="line"><span class="keyword">import</span> android.view.MenuItem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.adapter.MyTestPagerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MyTestPagerAdapter pagerAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ViewPager viewPager;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    TabLayout tabLayout;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DrawerLayout mDrawer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> NavigationView nvDrawer;</span><br><span class="line"></span><br><span class="line">    Toolbar toolbar;</span><br><span class="line">    ActionBarDrawerToggle drawerToggle;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_test);</span><br><span class="line">        pagerAdapter = <span class="keyword">new</span> MyTestPagerAdapter(getSupportFragmentManager(), <span class="keyword">this</span>);</span><br><span class="line">        viewPager = (ViewPager) findViewById(R.id.viewpager);</span><br><span class="line">        viewPager.setAdapter(pagerAdapter);</span><br><span class="line"></span><br><span class="line">        setupToolbar();</span><br><span class="line">        setupTablayout();</span><br><span class="line"></span><br><span class="line">        mDrawer = (DrawerLayout) findViewById(R.id.drawer_layout);</span><br><span class="line">        nvDrawer = (NavigationView) findViewById(R.id.nvView);</span><br><span class="line"></span><br><span class="line">        drawerToggle = setupDrawerToggle();</span><br><span class="line"></span><br><span class="line">        mDrawer.setDrawerListener(drawerToggle);</span><br><span class="line"></span><br><span class="line">        setupDrawerContent(nvDrawer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        viewPager.addOnPageChangeListener(<span class="keyword">new</span> ViewPager.OnPageChangeListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageScrolled</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">float</span> positionOffset, <span class="keyword">int</span> positionOffsetPixels)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageSelected</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageScrollStateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        drawerToggle.syncState();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration newConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onConfigurationChanged(newConfig);</span><br><span class="line">        <span class="comment">// Pass any configuration change to the drawer toggles</span></span><br><span class="line">        drawerToggle.onConfigurationChanged(newConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ActionBarDrawerToggle <span class="title">setupDrawerToggle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActionBarDrawerToggle(<span class="keyword">this</span>, mDrawer, toolbar, R.string.drawer_open, R.string.drawer_close);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupDrawerContent</span><span class="params">(NavigationView nvDrawer)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        nvDrawer.setNavigationItemSelectedListener(<span class="keyword">new</span> NavigationView.OnNavigationItemSelectedListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onNavigationItemSelected</span><span class="params">(MenuItem menuItem)</span> </span>&#123;</span><br><span class="line">                selectDrawerItem(menuItem);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">selectDrawerItem</span><span class="params">(MenuItem menuItem)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (menuItem.getItemId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.nav_first_fragment:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.nav_second_fragment:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.nav_third_fragment:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.nav_fourth_fragment:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        menuItem.setChecked(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//setTitle(menuItem.getTitle());</span></span><br><span class="line">        mDrawer.closeDrawers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupTablayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        tabLayout = (TabLayout) findViewById(R.id.tabLayout);</span><br><span class="line">        tabLayout.setupWithViewPager(viewPager);</span><br><span class="line">        tabLayout.setTabMode(TabLayout.MODE_FIXED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupToolbar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        toolbar = (Toolbar) findViewById(R.id.toolbar);</span><br><span class="line">        setSupportActionBar(toolbar);</span><br><span class="line">        <span class="comment">// Show menu icon</span></span><br><span class="line">        <span class="keyword">final</span> ActionBar ab = getSupportActionBar();</span><br><span class="line">        ab.setDisplayHomeAsUpEnabled(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">        getMenuInflater().inflate(R.menu.menu_test, menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = item.getItemId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id == R.id.action_settings) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(id == android.R.id.home)&#123;</span><br><span class="line">            mDrawer.openDrawer(GravityCompat.START);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (drawerToggle.onOptionsItemSelected(item)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>辅助Adapter：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.Fragment;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.FragmentManager;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.FragmentPagerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.fragment.MyTestFragment;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/9/17.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTestPagerAdapter</span> <span class="keyword">extends</span> <span class="title">FragmentPagerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> PAGE_COUNT = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> String tabTitles[] = <span class="keyword">new</span> String[]&#123;<span class="string">"科大"</span>,<span class="string">"工大"</span>,<span class="string">"安大"</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyTestPagerAdapter</span><span class="params">(FragmentManager fm, Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(fm);</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Fragment <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MyTestFragment.newInstance(position + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PAGE_COUNT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CharSequence <span class="title">getPageTitle</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tabTitles[position];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>辅助Fragment：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.fragment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.Fragment;</span><br><span class="line"><span class="keyword">import</span> android.view.Gravity;</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/1.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTestFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ARG_PAGE = <span class="string">"ARG_PAGE"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mPage;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyTestFragment <span class="title">newInstance</span><span class="params">(<span class="keyword">int</span> page)</span> </span>&#123;</span><br><span class="line">        Bundle args = <span class="keyword">new</span> Bundle();</span><br><span class="line">        args.putInt(ARG_PAGE, page);</span><br><span class="line">        MyTestFragment myFragment = <span class="keyword">new</span> MyTestFragment();</span><br><span class="line">        myFragment.setArguments(args);</span><br><span class="line">        <span class="keyword">return</span> myFragment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        mPage = getArguments().getInt(ARG_PAGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Nullable</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        TextView tv = <span class="keyword">new</span> TextView(getActivity());</span><br><span class="line">        tv.setGravity(Gravity.CENTER);</span><br><span class="line">        tv.setTextSize(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mPage == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//科大</span></span><br><span class="line">            tv.setText(<span class="string">"科大"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPage == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">//工大</span></span><br><span class="line">            tv.setText(<span class="string">"工大"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPage == <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="comment">//安大</span></span><br><span class="line">            tv.setText(<span class="string">"安大"</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>侧滑菜单的menu布局：<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">menu</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">xmlns:app</span>=<span class="value">"http://schemas.android.com/apk/res-auto"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">group</span> <span class="attribute">android:checkableBehavior</span>=<span class="value">"single"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">item</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/nav_first_fragment"</span></span><br><span class="line">            <span class="attribute">android:title</span>=<span class="value">"精品应用"</span></span><br><span class="line">            <span class="attribute">app:itemTextColor</span>=<span class="value">"@color/teal_500"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">item</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/nav_second_fragment"</span></span><br><span class="line"></span><br><span class="line">            <span class="attribute">android:title</span>=<span class="value">"玩机器人"</span></span><br><span class="line">            <span class="attribute">app:itemTextColor</span>=<span class="value">"@color/teal_500"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">item</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/nav_third_fragment"</span></span><br><span class="line"></span><br><span class="line">            <span class="attribute">android:title</span>=<span class="value">"给我建议"</span></span><br><span class="line">            <span class="attribute">app:itemTextColor</span>=<span class="value">"@color/teal_500"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">item</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/nav_fourth_fragment"</span></span><br><span class="line"></span><br><span class="line">            <span class="attribute">android:title</span>=<span class="value">"关于软件"</span></span><br><span class="line">            <span class="attribute">app:itemTextColor</span>=<span class="value">"@color/teal_500"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="title">group</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">menu</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>该Activity的主题为：<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">style</span> <span class="attribute">name</span>=<span class="value">"Base.Theme.Test"</span> <span class="attribute">parent</span>=<span class="value">"Theme.AppCompat.Light.NoActionBar"</span>&gt;</span><span class="css"></span><br><span class="line"></span><br><span class="line">       &lt;<span class="tag">item</span> <span class="tag">name</span>="<span class="tag">colorPrimary</span>"&gt;<span class="at_rule">@<span class="keyword">color/teal_500&lt;/item&gt;</span></span><br><span class="line"></span><br><span class="line">       &lt;!--   darker variant for the status bar and contextual app bars --&gt;</span><br><span class="line">       &lt;item name=<span class="string">"colorPrimaryDark"</span>&gt;@color/teal_400&lt;/item&gt;</span><br><span class="line"></span><br><span class="line">       &lt;!--   theme UI controls like checkboxes and text fields e.g. FloatActionButton --&gt;</span><br><span class="line">       &lt;item name=<span class="string">"colorAccent"</span>&gt;@color/teal_900&lt;/item&gt;</span><br><span class="line"></span><br><span class="line">       &lt;!-- Title Text Color --&gt;</span><br><span class="line">       &lt;item name=<span class="string">"android:textColorPrimary"</span>&gt;@color/my_primary_text&lt;/item&gt;</span><br><span class="line"></span><br><span class="line">       &lt;!-- color of the menu overflow icon (three vertical dots) --&gt;</span><br><span class="line">       &lt;item name=<span class="string">"android:textColorSecondary"</span>&gt;@color/my_secondary_text&lt;/item&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       &lt;item name=<span class="string">"android:windowBackground"</span>&gt;@color/white&lt;/item&gt;</span><br><span class="line">   </span></span><span class="tag">&lt;/<span class="title">style</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="2015-10-01晚上">2015.10.01晚上</h1><h2 id="主界面">主界面</h2><p>晚上使用<code>TabLayout</code>,<code>DrawerLayout</code>,<code>NavigationView</code>,<code>Toolbar</code>,<code>ViewPager</code>搭建程序主界面。<br><img src="http://7xljei.com1.z0.glb.clouddn.com/mainframe.gif" alt="效果图如下"><br>具体需要注意的是：由于tab的页卡比较多，因此在实现的时候，注意下面的：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//如果是三个，则是下面的固定的模式</span></span><br><span class="line"><span class="comment">//tabLayout.setTabMode(TabLayout.MODE_FIXED);</span></span><br><span class="line">tabLayout.setTabMode(TabLayout.MODE_SCROLLABLE);</span><br></pre></td></tr></table></figure></p>
<p>其他的和上午的处理一致，此处是模版代码，以后可以直接拿来用。</p>
<h2 id="抽取BaseActivity">抽取BaseActivity</h2><p>主要是管理Activity方便，没有做UI方面的，比如统一的initView啥的。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.Menu;</span><br><span class="line"><span class="keyword">import</span> android.view.MenuItem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//增删比较快</span></span><br><span class="line">    <span class="keyword">static</span> List&lt;BaseActivity&gt; baseActivityList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_base);</span><br><span class="line">        <span class="keyword">synchronized</span> (baseActivityList) &#123;</span><br><span class="line">            baseActivityList.add(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        <span class="keyword">synchronized</span> (baseActivityList) &#123;</span><br><span class="line">            baseActivityList.remove(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">killAllActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;BaseActivity&gt; copyList;</span><br><span class="line">        <span class="keyword">synchronized</span> (baseActivityList) &#123;</span><br><span class="line">            copyList = <span class="keyword">new</span> LinkedList&lt;&gt;(baseActivityList);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (BaseActivity activity : copyList) &#123;</span><br><span class="line">            activity.finish();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Inflate the menu; this adds items to the action bar if it is present.</span></span><br><span class="line">        getMenuInflater().inflate(R.menu.menu_base, menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Handle action bar item clicks here. The action bar will</span></span><br><span class="line">        <span class="comment">// automatically handle clicks on the Home/Up button, so long</span></span><br><span class="line">        <span class="comment">// as you specify a parent activity in AndroidManifest.xml.</span></span><br><span class="line">        <span class="keyword">int</span> id = item.getItemId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">        <span class="keyword">if</span> (id == R.id.action_settings) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="FragmentFactory">FragmentFactory</h2><p>Fragment的工场，我这里使用<code>ArrayMap</code>替换<code>HashMap</code>，做了优化。(<code>SparseArray</code>也可以)<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.fragment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.Fragment;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.util.ArrayMap;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/1.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = FragmentFactory.class.getSimpleName();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ArrayMap&lt;Integer, Fragment&gt; fragmentArrayMap = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Fragment <span class="title">createFragment</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        Fragment fragment;</span><br><span class="line">        fragment = fragmentArrayMap.get(position);</span><br><span class="line">        <span class="keyword">if</span> (fragment == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            Log.e(TAG, <span class="string">"createFragment "</span> + <span class="string">"Fragment为null执行"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (position == <span class="number">0</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> HomeFragment();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">1</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> AppFragment();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">2</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> GameFragment();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">3</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> SubjectFragment();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">4</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> RecommentFragment();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">5</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> CategoryFragment();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">6</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> HotFragment();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fragment != <span class="keyword">null</span>) &#123;</span><br><span class="line">                fragmentArrayMap.put(position, fragment);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fragment;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在adapter中使用：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.Fragment;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.FragmentManager;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.FragmentPagerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.fragment.FragmentFactory;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.fragment.MyTestFragment;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/9/17.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTestPagerAdapter</span> <span class="keyword">extends</span> <span class="title">FragmentPagerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String tabTitles[];</span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyTestPagerAdapter</span><span class="params">(FragmentManager fm, Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(fm);</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        tabTitles = context.getResources().getStringArray(R.array.tab_names);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Fragment <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FragmentFactory.createFragment(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tabTitles.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CharSequence <span class="title">getPageTitle</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tabTitles[position];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="广播退出Activity">广播退出Activity</h2><p>在BaseActivity中：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.content.IntentFilter;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.Menu;</span><br><span class="line"><span class="keyword">import</span> android.view.MenuItem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//增删比较快</span></span><br><span class="line">    <span class="keyword">static</span> List&lt;BaseActivity&gt; baseActivityList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> KillAllActivityReceiver receiver;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KILL_ALL_ACTIVITY_ACTION = <span class="string">"me.chenfuduo.mymarketpro.KILL_ALL"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">KillAllActivityReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">            finish();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_base);</span><br><span class="line">        receiver = <span class="keyword">new</span> KillAllActivityReceiver();</span><br><span class="line">        IntentFilter filter = <span class="keyword">new</span> IntentFilter(KILL_ALL_ACTIVITY_ACTION);</span><br><span class="line">        registerReceiver(receiver, filter);</span><br><span class="line">        <span class="keyword">synchronized</span> (baseActivityList) &#123;</span><br><span class="line">            baseActivityList.add(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        <span class="keyword">synchronized</span> (baseActivityList) &#123;</span><br><span class="line">            baseActivityList.remove(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (receiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">            unregisterReceiver(receiver);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">killAllActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;BaseActivity&gt; copyList;</span><br><span class="line">        <span class="keyword">synchronized</span> (baseActivityList) &#123;</span><br><span class="line">            copyList = <span class="keyword">new</span> LinkedList&lt;&gt;(baseActivityList);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (BaseActivity activity : copyList) &#123;</span><br><span class="line">            activity.finish();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Inflate the menu; this adds items to the action bar if it is present.</span></span><br><span class="line">        getMenuInflater().inflate(R.menu.menu_base, menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Handle action bar item clicks here. The action bar will</span></span><br><span class="line">        <span class="comment">// automatically handle clicks on the Home/Up button, so long</span></span><br><span class="line">        <span class="comment">// as you specify a parent activity in AndroidManifest.xml.</span></span><br><span class="line">        <span class="keyword">int</span> id = item.getItemId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">        <span class="keyword">if</span> (id == R.id.action_settings) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当在其他的Activity中，想要退出时：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    sendBroadcast(<span class="keyword">new</span> Intent(BaseActivity.KILL_ALL_ACTIVITY_ACTION));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="2015-10-02上午">2015.10.02上午</h1><h2 id="显示界面的架子">显示界面的架子</h2><p>在HomeFragment中：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Nullable</span></span><br><span class="line">   <span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">       Log.e(TAG, <span class="string">" HomeFragment onCreateView "</span>);</span><br><span class="line">       frameLayout = <span class="keyword">new</span> FrameLayout(getActivity());</span><br><span class="line">       init();</span><br><span class="line">       showPage();</span><br><span class="line">       show();</span><br><span class="line">       <span class="keyword">return</span> frameLayout;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>每一个界面都有：加载中,加载成功,加载失败,加载数据为空这几种不同的布局,将这些布局添加到FrameLayout中进行管理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//加载中</span></span><br><span class="line">    <span class="keyword">private</span> View loadingView;</span><br><span class="line">    <span class="comment">//加载失败</span></span><br><span class="line">    <span class="keyword">private</span> View errorView;</span><br><span class="line">    <span class="comment">//为空</span></span><br><span class="line">    <span class="keyword">private</span> View emptyView;</span><br><span class="line">    <span class="comment">//加载成功</span></span><br><span class="line">    <span class="keyword">private</span> View successView;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//在FrameLayout中添加四种界面。加载成功;加载失败;加载成功,但是没数据;加载中。</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        loadingView = createLoadingView();</span><br><span class="line">        <span class="keyword">if</span> (loadingView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            frameLayout.addView(loadingView, <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                    ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        errorView = createErrorView();</span><br><span class="line">        <span class="keyword">if</span> (errorView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            frameLayout.addView(errorView, <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                    ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emptyView = createEmptyView();</span><br><span class="line">        <span class="keyword">if</span> (emptyView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            frameLayout.addView(emptyView, <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                    ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>去加载不同的布局：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//加载中的布局</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> View <span class="title">createLoadingView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    View view = View.inflate(getActivity(), R.layout.loading_page_loading, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> view;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//加载失败的布局</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> View <span class="title">createErrorView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    View view = View.inflate(getActivity(), R.layout.loading_page_error, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> view;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为空的布局</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> View <span class="title">createEmptyView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    View view = View.inflate(getActivity(), R.layout.loading_page_empty, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> view;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="五种状态">五种状态</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//五种状态</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_UNKOWN = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_LOADING = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_ERROR = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_EMPTY = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_SUCCESS = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> state = STATE_UNKOWN;</span><br></pre></td></tr></table></figure>
<p>根据不同状态,显示不同的界面</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//根据不同状态,显示不同的界面</span></span><br><span class="line"><span class="comment">//五种状态,未知;加载中;错误;空;加载成功</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (loadingView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        loadingView.setVisibility(</span><br><span class="line">                state == STATE_UNKOWN || state == STATE_LOADING ? View.VISIBLE : View.INVISIBLE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (errorView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        errorView.setVisibility(state == STATE_ERROR ? View.VISIBLE : View.INVISIBLE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (emptyView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        emptyView.setVisibility(state == STATE_EMPTY ? View.VISIBLE : View.INVISIBLE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请求服务器数据,得到状态,这里只做模拟，后面再去修改。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//请求服务器,服务器返回只有三种状态</span></span><br><span class="line"><span class="comment">//错误,空,成功</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> LoadResult &#123;</span><br><span class="line">    error(<span class="number">2</span>), empty(<span class="number">3</span>), success(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//枚举类的构造器只能使用private</span></span><br><span class="line">    LoadResult(<span class="keyword">int</span> value) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据服务器的数据,切换状态</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (state == STATE_ERROR || state == STATE_EMPTY)&#123;</span><br><span class="line">        state = STATE_LOADING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求服务器,获取服务器上的数据,进行判断</span></span><br><span class="line">    <span class="comment">//请求服务器,返回一个结果</span></span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            SystemClock.sleep(<span class="number">3000</span>);</span><br><span class="line">            <span class="keyword">final</span> LoadResult result = load();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//这里报过空指针</span></span><br><span class="line">            <span class="comment">//当快速退出,快速进入的时候,偶尔出现</span></span><br><span class="line">            <span class="comment">//可能与Fragment工场的缓存有关</span></span><br><span class="line">            getActivity().runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        state = result.getValue();</span><br><span class="line">                        <span class="comment">//状态改变了,重新判断当前应该显示哪个界面</span></span><br><span class="line">                        showPage();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    showPage();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> LoadResult <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> LoadResult.error;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://7xljei.com1.z0.glb.clouddn.com/frame1002.gif" alt="效果图"></p>
<h2 id="复用FrameLayout的问题">复用FrameLayout的问题</h2><p>log日志是：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.lang.IllegalStateException The specified child already has a parent.&#10;You must call removeView() on the child&#39;s parent first.</span><br></pre></td></tr></table></figure></p>
<p>解决方法：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Nullable</span></span><br><span class="line">   <span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">       Log.e(TAG, <span class="string">" HomeFragment onCreateView "</span>);</span><br><span class="line">       <span class="keyword">if</span> (frameLayout == <span class="keyword">null</span>) &#123;</span><br><span class="line">           frameLayout = <span class="keyword">new</span> FrameLayout(getActivity());</span><br><span class="line">           init();</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           ViewUtils.removeSelfFromParent(frameLayout);</span><br><span class="line">       &#125;</span><br><span class="line">       showPage();</span><br><span class="line">       show();</span><br><span class="line">       <span class="keyword">return</span> frameLayout;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>把自身从父View中移除:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="comment">/** 把自身从父View中移除 */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeSelfFromParent</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">		ViewParent parent = view.getParent();</span><br><span class="line">		<span class="keyword">if</span> (parent != <span class="keyword">null</span> &amp;&amp; parent <span class="keyword">instanceof</span> ViewGroup) &#123;</span><br><span class="line">			ViewGroup group = (ViewGroup) parent;</span><br><span class="line">			group.removeView(view);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2015-10-02下午">2015.10.02下午</h1><h2 id="抽取到BaseFragment中">抽取到BaseFragment中</h2><p>上午在HomeFragment中写了一大堆的代码,但是在其他的Fragment中,仍然用得到这些,将其抽取到BaseFragment中：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.fragment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.SystemClock;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.Fragment;</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.FrameLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.ViewUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/2.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="comment">//五种状态</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_UNKOWN = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_LOADING = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_ERROR = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_EMPTY = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_SUCCESS = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//不能使用static</span></span><br><span class="line">    <span class="comment">// static int state = STATE_UNKOWN;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> state = STATE_UNKOWN;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//四种界面</span></span><br><span class="line">    <span class="comment">//加载中</span></span><br><span class="line">    <span class="keyword">private</span> View loadingView;</span><br><span class="line">    <span class="comment">//加载失败</span></span><br><span class="line">    <span class="keyword">private</span> View errorView;</span><br><span class="line">    <span class="comment">//为空</span></span><br><span class="line">    <span class="keyword">private</span> View emptyView;</span><br><span class="line">    <span class="comment">//加载成功</span></span><br><span class="line">    <span class="keyword">private</span> View successView;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    FrameLayout frameLayout;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Nullable</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (frameLayout == <span class="keyword">null</span>) &#123;</span><br><span class="line">            frameLayout = <span class="keyword">new</span> FrameLayout(getActivity());</span><br><span class="line">            init();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ViewUtils.removeSelfFromParent(frameLayout);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> frameLayout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//在FrameLayout中添加四种界面。加载成功;加载失败;加载成功,但是没数据;加载中。</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        loadingView = createLoadingView();</span><br><span class="line">        <span class="keyword">if</span> (loadingView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            frameLayout.addView(loadingView, <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                    FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        errorView = createErrorView();</span><br><span class="line">        <span class="keyword">if</span> (errorView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            frameLayout.addView(errorView, <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                    FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emptyView = createEmptyView();</span><br><span class="line">        <span class="keyword">if</span> (emptyView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            frameLayout.addView(emptyView, <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                    FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line">        showPage();<span class="comment">// 根据不同的状态显示不同的界面</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据不同状态,显示不同的界面</span></span><br><span class="line">    <span class="comment">//五种状态,未知;加载中;错误;空;加载成功</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (loadingView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            loadingView.setVisibility(</span><br><span class="line">                    state == STATE_UNKOWN || state == STATE_LOADING ? View.VISIBLE : View.INVISIBLE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (errorView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            errorView.setVisibility(state == STATE_ERROR ? View.VISIBLE : View.INVISIBLE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (emptyView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            emptyView.setVisibility(state == STATE_EMPTY ? View.VISIBLE : View.INVISIBLE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state == STATE_SUCCESS) &#123;</span><br><span class="line">            successView = createSuccessView();</span><br><span class="line">            <span class="keyword">if</span> (successView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                frameLayout.addView(successView, <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                        FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT));</span><br><span class="line"></span><br><span class="line">                successView.setVisibility(View.VISIBLE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (successView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                successView.setVisibility(View.INVISIBLE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载中的布局</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> View <span class="title">createLoadingView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        View view = View.inflate(getActivity(), R.layout.loading_page_loading, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载失败的布局</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> View <span class="title">createErrorView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        View view = View.inflate(getActivity(), R.layout.loading_page_error, <span class="keyword">null</span>);</span><br><span class="line">        Button page_bt = (Button) view.findViewById(R.id.page_bt);</span><br><span class="line">        page_bt.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为空的布局</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> View <span class="title">createEmptyView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        View view = View.inflate(getActivity(), R.layout.loading_page_empty, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求服务器,服务器返回只有三种状态</span></span><br><span class="line">    <span class="comment">//错误,空,成功</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> LoadResult &#123;</span><br><span class="line">        error(<span class="number">2</span>), empty(<span class="number">3</span>), success(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//枚举类的构造器只能使用private</span></span><br><span class="line">        LoadResult(<span class="keyword">int</span> value) &#123;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据服务器的数据,切换状态</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state == STATE_ERROR || state == STATE_EMPTY) &#123;</span><br><span class="line">            state = STATE_LOADING;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求服务器,获取服务器上的数据,进行判断</span></span><br><span class="line">        <span class="comment">//请求服务器,返回一个结果</span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                SystemClock.sleep(<span class="number">1500</span>);</span><br><span class="line">                <span class="keyword">final</span> LoadResult result = load();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//这里报过空指针</span></span><br><span class="line">                <span class="comment">//当快速退出,快速进入的时候,偶尔出现</span></span><br><span class="line">                <span class="comment">//可能与Fragment工场的缓存有关</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (getActivity() != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    getActivity().runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="annotation">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                state = result.getValue();</span><br><span class="line">                                <span class="comment">//state = 2 + new Random().nextInt(3);</span></span><br><span class="line">                                <span class="comment">//状态改变了,重新判断当前应该显示哪个界面</span></span><br><span class="line">                                showPage();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        showPage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 请求服务器数据</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> LoadResult <span class="title">load</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 创建成功的界面</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> View <span class="title">createSuccessView</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后HomeFragment以及其他的几个Fragment继承自BaseFragment：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.fragment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.Gravity;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/1.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeFragment</span> <span class="keyword">extends</span> <span class="title">BaseFragment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = HomeFragment.class.getSimpleName();</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> View <span class="title">createSuccessView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TextView tv = <span class="keyword">new</span> TextView(getActivity());</span><br><span class="line">        tv.setGravity(Gravity.CENTER);</span><br><span class="line">        tv.setTextSize(<span class="number">16</span>);</span><br><span class="line">        tv.setText(<span class="string">"成功的界面"</span>);</span><br><span class="line">        <span class="keyword">return</span> tv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LoadResult <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LoadResult.success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">        show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>前面的Fragment工厂也修改如下：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.fragment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.support.v4.util.ArrayMap;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/1.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FragmentFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = FragmentFactory.class.getSimpleName();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ArrayMap&lt;Integer, BaseFragment&gt; fragmentArrayMap = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ArrayMap和SparseArray都能达到优化</span></span><br><span class="line">   <span class="comment">// private static SparseArray&lt;Fragment&gt; sparseFragments = new SparseArray&lt;&gt;();</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BaseFragment <span class="title">createFragment</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        BaseFragment fragment;</span><br><span class="line">        fragment = fragmentArrayMap.get(position);</span><br><span class="line">        <span class="comment">//sparseFragments.get(position);</span></span><br><span class="line">        <span class="comment">// sparseFragments.put(position,fragment);</span></span><br><span class="line">        <span class="keyword">if</span> (fragment == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            Log.e(TAG, <span class="string">"createFragment "</span> + <span class="string">"Fragment为null执行"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (position == <span class="number">0</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> HomeFragment();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">1</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> AppFragment();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">2</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> GameFragment();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">3</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> SubjectFragment();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">4</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> RecommentFragment();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">5</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> CategoryFragment();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">6</span>) &#123;</span><br><span class="line">                fragment = <span class="keyword">new</span> HotFragment();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fragment != <span class="keyword">null</span>) &#123;</span><br><span class="line">                fragmentArrayMap.put(position, fragment);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fragment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同时MainActivity的ViewPager在滑动的时候,让其重新加载：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">viewPager.addOnPageChangeListener(<span class="keyword">new</span> ViewPager.OnPageChangeListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageScrolled</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">float</span> positionOffset, <span class="keyword">int</span> positionOffsetPixels)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageSelected</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">                BaseFragment fragment =</span><br><span class="line">                        FragmentFactory.createFragment(position);</span><br><span class="line">                fragment.show();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageScrollStateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="抽取到LoadingPage">抽取到LoadingPage</h2><p>出现了下面的错误:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.lang.NullPointerException&#10;            at android.view.LayoutInflater.from(LayoutInflater.java:210)&#10;            at android.view.View.inflate(View.java:16118)&#10;            at me.chenfuduo.mymarketpro.view.LoadingPage.createLoadingView(LoadingPage.java:108)&#10;            at me.chenfuduo.mymarketpro.view.LoadingPage.init(LoadingPage.java:56)&#10;            at me.chenfuduo.mymarketpro.view.LoadingPage.&#60;init&#62;(LoadingPage.java:51)&#10;            at me.chenfuduo.mymarketpro.view.LoadingPage.&#60;init&#62;(LoadingPage.java:46)&#10;            at me.chenfuduo.mymarketpro.view.LoadingPage.&#60;init&#62;(LoadingPage.java:42)&#10;            at me.chenfuduo.mymarketpro.fragment.BaseFragment$1.&#60;init&#62;(BaseFragment.java:24)&#10;            at me.chenfuduo.mymarketpro.fragment.BaseFragment.onCreateView(BaseFragment.java:24)</span><br></pre></td></tr></table></figure></p>
<p>检查了半天,原来清单文件的Application节点忘了name属性添加上去了。囧。</p>
<p>BaseFragment中的一些代码抽取到LoadingPage中：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.view;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.SystemClock;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.FrameLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.UIUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/2.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadingPage</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//五种状态</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_UNKOWN = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_LOADING = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_ERROR = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_EMPTY = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_SUCCESS = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//不能使用static</span></span><br><span class="line">    <span class="comment">// static int state = STATE_UNKOWN;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> state = STATE_UNKOWN;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//四种界面</span></span><br><span class="line">    <span class="comment">//加载中</span></span><br><span class="line">    <span class="keyword">private</span> View loadingView;</span><br><span class="line">    <span class="comment">//加载失败</span></span><br><span class="line">    <span class="keyword">private</span> View errorView;</span><br><span class="line">    <span class="comment">//为空</span></span><br><span class="line">    <span class="keyword">private</span> View emptyView;</span><br><span class="line">    <span class="comment">//加载成功</span></span><br><span class="line">    <span class="keyword">private</span> View successView;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoadingPage</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoadingPage</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoadingPage</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在FrameLayout中添加四种界面。加载成功;加载失败;加载成功,但是没数据;加载中。</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        loadingView = createLoadingView();</span><br><span class="line">        <span class="keyword">if</span> (loadingView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.addView(loadingView, <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                    FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        errorView = createErrorView();</span><br><span class="line">        <span class="keyword">if</span> (errorView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.addView(errorView, <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                    FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        emptyView = createEmptyView();</span><br><span class="line">        <span class="keyword">if</span> (emptyView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.addView(emptyView, <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                    FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line">        showPage();<span class="comment">// 根据不同的状态显示不同的界面</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据不同状态,显示不同的界面</span></span><br><span class="line">    <span class="comment">//五种状态,未知;加载中;错误;空;加载成功</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (loadingView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            loadingView.setVisibility(</span><br><span class="line">                    state == STATE_UNKOWN || state == STATE_LOADING ? View.VISIBLE : View.INVISIBLE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (errorView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            errorView.setVisibility(state == STATE_ERROR ? View.VISIBLE : View.INVISIBLE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (emptyView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            emptyView.setVisibility(state == STATE_EMPTY ? View.VISIBLE : View.INVISIBLE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state == STATE_SUCCESS) &#123;</span><br><span class="line">            successView = createSuccessView();</span><br><span class="line">            <span class="keyword">if</span> (successView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.addView(successView, <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                        FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT));</span><br><span class="line"></span><br><span class="line">                successView.setVisibility(View.VISIBLE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (successView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                successView.setVisibility(View.INVISIBLE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载中的布局</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> View <span class="title">createLoadingView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        View view = View.inflate(UIUtils.getContext(), R.layout.loading_page_loading, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载失败的布局</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> View <span class="title">createErrorView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        View view = View.inflate(UIUtils.getContext(), R.layout.loading_page_error, <span class="keyword">null</span>);</span><br><span class="line">        Button page_bt = (Button) view.findViewById(R.id.page_bt);</span><br><span class="line">        page_bt.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为空的布局</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> View <span class="title">createEmptyView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        View view = View.inflate(UIUtils.getContext(), R.layout.loading_page_empty, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求服务器,服务器返回只有三种状态</span></span><br><span class="line">    <span class="comment">//错误,空,成功</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> LoadResult &#123;</span><br><span class="line">        error(<span class="number">2</span>), empty(<span class="number">3</span>), success(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//枚举类的构造器只能使用private</span></span><br><span class="line">        LoadResult(<span class="keyword">int</span> value) &#123;</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据服务器的数据,切换状态</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state == STATE_ERROR || state == STATE_EMPTY) &#123;</span><br><span class="line">            state = STATE_LOADING;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求服务器,获取服务器上的数据,进行判断</span></span><br><span class="line">        <span class="comment">//请求服务器,返回一个结果</span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                SystemClock.sleep(<span class="number">1500</span>);</span><br><span class="line">                <span class="keyword">final</span> LoadResult result = load();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//这里报过空指针</span></span><br><span class="line">                <span class="comment">//当快速退出,快速进入的时候,偶尔出现</span></span><br><span class="line">                <span class="comment">//可能与Fragment工场的缓存有关</span></span><br><span class="line">                UIUtils.runInMainThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            state = result.getValue();</span><br><span class="line">                            <span class="comment">//state = 2 + new Random().nextInt(3);</span></span><br><span class="line">                            <span class="comment">//状态改变了,重新判断当前应该显示哪个界面</span></span><br><span class="line">                            showPage();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        showPage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 请求服务器数据</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> LoadResult <span class="title">load</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 创建成功的界面</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> View <span class="title">createSuccessView</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>那么现在BaseFrament就是这样了：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.fragment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.Fragment;</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.ViewUtils;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.view.LoadingPage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/2.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    LoadingPage loadingPage;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Nullable</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (loadingPage == <span class="keyword">null</span>) &#123;</span><br><span class="line">            loadingPage = <span class="keyword">new</span> LoadingPage(getActivity())&#123;</span><br><span class="line"></span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> LoadResult <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> BaseFragment.<span class="keyword">this</span>.load();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> View <span class="title">createSuccessView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> BaseFragment.<span class="keyword">this</span>.createSuccessView();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ViewUtils.removeSelfFromParent(loadingPage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> loadingPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 请求服务器数据</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> LoadingPage.<span class="function">LoadResult <span class="title">load</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 创建成功的界面</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> View <span class="title">createSuccessView</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (loadingPage != <span class="keyword">null</span>)&#123;</span><br><span class="line">            loadingPage.show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="线程池原理">线程池原理</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.manager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor.AbortPolicy;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 一个简易的线程池管理类，提供三个线程池</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadManager</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SINGLE_POOL_NAME = <span class="string">"DEFAULT_SINGLE_POOL_NAME"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ThreadPoolProxy mLongPool = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Object mLongLock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ThreadPoolProxy mShortPool = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Object mShortLock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ThreadPoolProxy mDownloadPool = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Object mDownloadLock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, ThreadPoolProxy&gt; mMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Object mSingleLock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取下载线程 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadPoolProxy <span class="title">getDownloadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (mDownloadLock) &#123;</span><br><span class="line">			<span class="keyword">if</span> (mDownloadPool == <span class="keyword">null</span>) &#123;</span><br><span class="line">				mDownloadPool = <span class="keyword">new</span> ThreadPoolProxy(<span class="number">3</span>, <span class="number">3</span>, <span class="number">5L</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> mDownloadPool;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取一个用于执行长耗时任务的线程池，避免和短耗时任务处在同一个队列而阻塞了重要的短耗时任务，通常用来联网操作 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadPoolProxy <span class="title">getLongPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (mLongLock) &#123;</span><br><span class="line">			<span class="keyword">if</span> (mLongPool == <span class="keyword">null</span>) &#123;</span><br><span class="line">				mLongPool = <span class="keyword">new</span> ThreadPoolProxy(<span class="number">5</span>, <span class="number">5</span>, <span class="number">5L</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> mLongPool;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取一个用于执行短耗时任务的线程池，避免因为和耗时长的任务处在同一个队列而长时间得不到执行，通常用来执行本地的IO/SQL */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadPoolProxy <span class="title">getShortPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (mShortLock) &#123;</span><br><span class="line">			<span class="keyword">if</span> (mShortPool == <span class="keyword">null</span>) &#123;</span><br><span class="line">				mShortPool = <span class="keyword">new</span> ThreadPoolProxy(<span class="number">2</span>, <span class="number">2</span>, <span class="number">5L</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> mShortPool;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取一个单线程池，所有任务将会被按照加入的顺序执行，免除了同步开销的问题 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadPoolProxy <span class="title">getSinglePool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getSinglePool(DEFAULT_SINGLE_POOL_NAME);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取一个单线程池，所有任务将会被按照加入的顺序执行，免除了同步开销的问题 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadPoolProxy <span class="title">getSinglePool</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (mSingleLock) &#123;</span><br><span class="line">			ThreadPoolProxy singlePool = mMap.get(name);</span><br><span class="line">			<span class="keyword">if</span> (singlePool == <span class="keyword">null</span>) &#123;</span><br><span class="line">				singlePool = <span class="keyword">new</span> ThreadPoolProxy(<span class="number">1</span>, <span class="number">1</span>, <span class="number">5L</span>);</span><br><span class="line">				mMap.put(name, singlePool);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> singlePool;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolProxy</span> </span>&#123;</span><br><span class="line">		<span class="keyword">private</span> ThreadPoolExecutor mPool;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">int</span> mCorePoolSize;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">int</span> mMaximumPoolSize;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">long</span> mKeepAliveTime;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="title">ThreadPoolProxy</span><span class="params">(<span class="keyword">int</span> corePoolSize, <span class="keyword">int</span> maximumPoolSize, <span class="keyword">long</span> keepAliveTime)</span> </span>&#123;</span><br><span class="line">			mCorePoolSize = corePoolSize;</span><br><span class="line">			mMaximumPoolSize = maximumPoolSize;</span><br><span class="line">			mKeepAliveTime = keepAliveTime;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** 执行任务，当线程池处于关闭，将会重新创建新的线程池 */</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable run)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (run == <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (mPool == <span class="keyword">null</span> || mPool.isShutdown()) &#123;</span><br><span class="line">				<span class="comment">//参数说明</span></span><br><span class="line">				<span class="comment">//当线程池中的线程小于mCorePoolSize，直接创建新的线程加入线程池执行任务</span></span><br><span class="line">				<span class="comment">//当线程池中的线程数目等于mCorePoolSize，将会把任务放入任务队列BlockingQueue中</span></span><br><span class="line">				<span class="comment">//当BlockingQueue中的任务放满了，将会创建新的线程去执行，</span></span><br><span class="line">				<span class="comment">//但是当总线程数大于mMaximumPoolSize时，将会抛出异常，交给RejectedExecutionHandler处理</span></span><br><span class="line">				<span class="comment">//mKeepAliveTime是线程执行完任务后，且队列中没有可以执行的任务，存活的时间，后面的参数是时间单位</span></span><br><span class="line">				<span class="comment">//ThreadFactory是每次创建新的线程工厂</span></span><br><span class="line">				mPool = <span class="keyword">new</span> ThreadPoolExecutor(mCorePoolSize, mMaximumPoolSize, mKeepAliveTime,</span><br><span class="line">						TimeUnit.MILLISECONDS,</span><br><span class="line">						<span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(), Executors.defaultThreadFactory(), <span class="keyword">new</span> AbortPolicy());</span><br><span class="line">			&#125;</span><br><span class="line">			mPool.execute(run);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** 取消线程池中某个还未执行的任务 */</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">(Runnable run)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (mPool != <span class="keyword">null</span> &amp;&amp; (!mPool.isShutdown() || mPool.isTerminating())) &#123;</span><br><span class="line">				mPool.getQueue().remove(run);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** 取消线程池中某个还未执行的任务 */</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Runnable run)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (mPool != <span class="keyword">null</span> &amp;&amp; (!mPool.isShutdown() || mPool.isTerminating())) &#123;</span><br><span class="line">				<span class="keyword">return</span> mPool.getQueue().contains(run);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** 立刻关闭线程池，并且正在执行的任务也将会被中断 */</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (mPool != <span class="keyword">null</span> &amp;&amp; (!mPool.isShutdown() || mPool.isTerminating())) &#123;</span><br><span class="line">				mPool.shutdownNow();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** 平缓关闭单任务线程池，但是会确保所有已经加入的任务都将会被执行完毕才关闭 */</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (mPool != <span class="keyword">null</span> &amp;&amp; (!mPool.isShutdown() || mPool.isTerminating())) &#123;</span><br><span class="line">				mPool.shutdownNow();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么LoadingPage使用线程池管理：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ThreadManager.getLongPool().execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                SystemClock.sleep(<span class="number">1500</span>);</span><br><span class="line">                <span class="keyword">final</span> LoadResult result = load();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//这里报过空指针</span></span><br><span class="line">                <span class="comment">//当快速退出,快速进入的时候,偶尔出现</span></span><br><span class="line">                <span class="comment">//可能与Fragment工场的缓存有关</span></span><br><span class="line">                UIUtils.runInMainThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            state = result.getValue();</span><br><span class="line">                            <span class="comment">//state = 2 + new Random().nextInt(3);</span></span><br><span class="line">                            <span class="comment">//状态改变了,重新判断当前应该显示哪个界面</span></span><br><span class="line">                            showPage();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<h1 id="2015-10-02晚上">2015.10.02晚上</h1><h2 id="请求服务器的框架">请求服务器的框架</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.protocol;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/2.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeProtocol</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        String json = loadLocal(index);</span><br><span class="line">        <span class="keyword">if</span> (json == <span class="keyword">null</span>) &#123;</span><br><span class="line">            json = loadServer();</span><br><span class="line">            <span class="keyword">if</span> (json != <span class="keyword">null</span>)&#123;</span><br><span class="line">                saveLocal(json,index);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (json!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            parserJson(json);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="xUtils网络请求导致的错误">xUtils网络请求导致的错误</h2><p>Android6.0后,删除了HttpClient,所以在使用它的时候，会发生下面的错误：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Error:(42, 75) &#38169;&#35823;: &#26080;&#27861;&#35775;&#38382;HttpRequestBase&#10;&#25214;&#19981;&#21040;org.apache.http.client.methods.HttpRequestBase&#30340;&#31867;&#25991;&#20214;</span><br></pre></td></tr></table></figure></p>
<p>详细参考这个：<br><a href="http://blog.csdn.net/langwang2/article/details/48806241" target="_blank" rel="external">android6.0SDK中删除HttpClient的相关类的解决方法</a></p>
<p>我直接放弃这个框架了。</p>
<h2 id="联网请求数据">联网请求数据</h2><p>如上,放弃xUtils，使用Async-Http-Client或者自己写。这里都是自己写的,工具类在http包下：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">loadServer</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*xUtils框架请求由于Android6.0删除HttpClient会导致报错</span><br><span class="line">        HttpUtils httpUtils = new HttpUtils();</span><br><span class="line">        try &#123;</span><br><span class="line">            ResponseStream responseStream = httpUtils.sendSync(HttpRequest.HttpMethod.GET,</span><br><span class="line">                    "http://127.0.0.1:8090/home");</span><br><span class="line">            System.out.println(responseStream.toString());</span><br><span class="line">        &#125; catch (HttpException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">        AsyncHttpClient asyncHttpClient = new AsyncHttpClient();</span><br><span class="line">        asyncHttpClient.get("http://127.0.0.1:8090/home" + "?index=" + index, new AsyncHttpResponseHandler() &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onSuccess(int statusCode, Header[] headers, byte[] responseBody) &#123;</span><br><span class="line"></span><br><span class="line">                String response = new String(responseBody);</span><br><span class="line">                Log.e(TAG, "onSuccess " + response);</span><br><span class="line">                System.out.println(response);</span><br><span class="line">                Message message = Message.obtain();</span><br><span class="line">                message.obj = response;</span><br><span class="line">                sendMessage(message);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onFailure(int statusCode, Header[] headers, byte[] responseBody, Throwable error) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">        */</span></span><br><span class="line"></span><br><span class="line">        HttpHelper.HttpResult httpResult = HttpHelper.get(HttpHelper.URL + <span class="string">"home?index="</span> + index);</span><br><span class="line"></span><br><span class="line">        String json = httpResult.getString();</span><br><span class="line">        Log.e(TAG, <span class="string">"loadServer "</span> + json);</span><br><span class="line">        System.out.println(json);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="保存缓存到本地">保存缓存到本地</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveLocal</span><span class="params">(String json, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//在第一行写一个过期的时间</span></span><br><span class="line">        String dir = FileUtils.getCacheDir();</span><br><span class="line">        File file = <span class="keyword">new</span> File(dir, <span class="string">"home_"</span> + index);</span><br><span class="line">        BufferedWriter bw = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileWriter fileWriter = <span class="keyword">new</span> FileWriter(file);</span><br><span class="line">            bw = <span class="keyword">new</span> BufferedWriter(fileWriter);</span><br><span class="line">            bw.write(System.currentTimeMillis() + <span class="number">1000</span> * <span class="number">100</span> + <span class="string">""</span>);</span><br><span class="line">            bw.newLine();</span><br><span class="line">            bw.write(json);</span><br><span class="line">            bw.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (bw != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    bw.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>工具类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Environment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT_DIR = <span class="string">"chenfuduo"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DOWNLOAD_DIR = <span class="string">"download"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CACHE_DIR = <span class="string">"cache"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ICON_DIR = <span class="string">"icon"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 判断SD卡是否挂载 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSDCardAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState())) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取下载目录 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDownloadDir</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getDir(DOWNLOAD_DIR);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取缓存目录 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCacheDir</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getDir(CACHE_DIR);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取icon目录 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getIconDir</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getDir(ICON_DIR);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取应用目录，当SD卡存在时，获取SD卡上的目录，当SD卡不存在时，获取应用的cache目录 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDir</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		<span class="keyword">if</span> (isSDCardAvailable()) &#123;</span><br><span class="line">			sb.append(getExternalStoragePath());</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			sb.append(getCachePath());</span><br><span class="line">		&#125;</span><br><span class="line">		sb.append(name);</span><br><span class="line">		sb.append(File.separator);</span><br><span class="line">		String path = sb.toString();</span><br><span class="line">		<span class="keyword">if</span> (createDirs(path)) &#123;</span><br><span class="line">			<span class="keyword">return</span> path;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取SD下的应用目录 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getExternalStoragePath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		sb.append(Environment.getExternalStorageDirectory().getAbsolutePath());</span><br><span class="line">		sb.append(File.separator);</span><br><span class="line">		sb.append(ROOT_DIR);</span><br><span class="line">		sb.append(File.separator);</span><br><span class="line">		<span class="keyword">return</span> sb.toString();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取应用的cache目录 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCachePath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		File f = UIUtils.getContext().getCacheDir();</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">null</span> == f) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> f.getAbsolutePath() + <span class="string">"/"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 创建文件夹 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">createDirs</span><span class="params">(String dirPath)</span> </span>&#123;</span><br><span class="line">		File file = <span class="keyword">new</span> File(dirPath);</span><br><span class="line">		<span class="keyword">if</span> (!file.exists() || !file.isDirectory()) &#123;</span><br><span class="line">			<span class="keyword">return</span> file.mkdirs();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 复制文件，可以选择是否删除源文件 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">copyFile</span><span class="params">(String srcPath, String destPath, <span class="keyword">boolean</span> deleteSrc)</span> </span>&#123;</span><br><span class="line">		File srcFile = <span class="keyword">new</span> File(srcPath);</span><br><span class="line">		File destFile = <span class="keyword">new</span> File(destPath);</span><br><span class="line">		<span class="keyword">return</span> copyFile(srcFile, destFile, deleteSrc);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 复制文件，可以选择是否删除源文件 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">copyFile</span><span class="params">(File srcFile, File destFile, <span class="keyword">boolean</span> deleteSrc)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!srcFile.exists() || !srcFile.isFile()) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		InputStream in = <span class="keyword">null</span>;</span><br><span class="line">		OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			in = <span class="keyword">new</span> FileInputStream(srcFile);</span><br><span class="line">			out = <span class="keyword">new</span> FileOutputStream(destFile);</span><br><span class="line">			<span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">			<span class="keyword">int</span> i = -<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">while</span> ((i = in.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				out.write(buffer, <span class="number">0</span>, i);</span><br><span class="line">				out.flush();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (deleteSrc) &#123;</span><br><span class="line">				srcFile.delete();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			LogUtils.e(e);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			IOUtils.close(out);</span><br><span class="line">			IOUtils.close(in);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 判断文件是否可写 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isWriteable</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (StringUtils.isEmpty(path)) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			File f = <span class="keyword">new</span> File(path);</span><br><span class="line">			<span class="keyword">return</span> f.exists() &amp;&amp; f.canWrite();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			LogUtils.e(e);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 修改文件的权限,例如"777"等 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">chmod</span><span class="params">(String path, String mode)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String command = <span class="string">"chmod "</span> + mode + <span class="string">" "</span> + path;</span><br><span class="line">			Runtime runtime = Runtime.getRuntime();</span><br><span class="line">			runtime.exec(command);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			LogUtils.e(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 把数据写入文件</span><br><span class="line">	 * <span class="doctag">@param</span> is       数据流</span><br><span class="line">	 * <span class="doctag">@param</span> path     文件路径</span><br><span class="line">	 * <span class="doctag">@param</span> recreate 如果文件存在，是否需要删除重建</span><br><span class="line">	 * <span class="doctag">@return</span> 是否写入成功</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">writeFile</span><span class="params">(InputStream is, String path, <span class="keyword">boolean</span> recreate)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">boolean</span> res = <span class="keyword">false</span>;</span><br><span class="line">		File f = <span class="keyword">new</span> File(path);</span><br><span class="line">		FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (recreate &amp;&amp; f.exists()) &#123;</span><br><span class="line">				f.delete();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (!f.exists() &amp;&amp; <span class="keyword">null</span> != is) &#123;</span><br><span class="line">				File parentFile = <span class="keyword">new</span> File(f.getParent());</span><br><span class="line">				parentFile.mkdirs();</span><br><span class="line">				<span class="keyword">int</span> count = -<span class="number">1</span>;</span><br><span class="line">				<span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">				fos = <span class="keyword">new</span> FileOutputStream(f);</span><br><span class="line">				<span class="keyword">while</span> ((count = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">					fos.write(buffer, <span class="number">0</span>, count);</span><br><span class="line">				&#125;</span><br><span class="line">				res = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			LogUtils.e(e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			IOUtils.close(fos);</span><br><span class="line">			IOUtils.close(is);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 把字符串数据写入文件</span><br><span class="line">	 * <span class="doctag">@param</span> content 需要写入的字符串</span><br><span class="line">	 * <span class="doctag">@param</span> path    文件路径名称</span><br><span class="line">	 * <span class="doctag">@param</span> append  是否以添加的模式写入</span><br><span class="line">	 * <span class="doctag">@return</span> 是否写入成功</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">writeFile</span><span class="params">(<span class="keyword">byte</span>[] content, String path, <span class="keyword">boolean</span> append)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">boolean</span> res = <span class="keyword">false</span>;</span><br><span class="line">		File f = <span class="keyword">new</span> File(path);</span><br><span class="line">		RandomAccessFile raf = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (f.exists()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!append) &#123;</span><br><span class="line">					f.delete();</span><br><span class="line">					f.createNewFile();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				f.createNewFile();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (f.canWrite()) &#123;</span><br><span class="line">				raf = <span class="keyword">new</span> RandomAccessFile(f, <span class="string">"rw"</span>);</span><br><span class="line">				raf.seek(raf.length());</span><br><span class="line">				raf.write(content);</span><br><span class="line">				res = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			LogUtils.e(e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			IOUtils.close(raf);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 把字符串数据写入文件</span><br><span class="line">	 * <span class="doctag">@param</span> content 需要写入的字符串</span><br><span class="line">	 * <span class="doctag">@param</span> path    文件路径名称</span><br><span class="line">	 * <span class="doctag">@param</span> append  是否以添加的模式写入</span><br><span class="line">	 * <span class="doctag">@return</span> 是否写入成功</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">writeFile</span><span class="params">(String content, String path, <span class="keyword">boolean</span> append)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> writeFile(content.getBytes(), path, append);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 把键值对写入文件</span><br><span class="line">	 * <span class="doctag">@param</span> filePath 文件路径</span><br><span class="line">	 * <span class="doctag">@param</span> key      键</span><br><span class="line">	 * <span class="doctag">@param</span> value    值</span><br><span class="line">	 * <span class="doctag">@param</span> comment  该键值对的注释</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeProperties</span><span class="params">(String filePath, String key, String value, String comment)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isEmpty(key) || StringUtils.isEmpty(filePath)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">		FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">		File f = <span class="keyword">new</span> File(filePath);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (!f.exists() || !f.isFile()) &#123;</span><br><span class="line">				f.createNewFile();</span><br><span class="line">			&#125;</span><br><span class="line">			fis = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line">			Properties p = <span class="keyword">new</span> Properties();</span><br><span class="line">			p.load(fis);<span class="comment">// 先读取文件，再把键值对追加到后面</span></span><br><span class="line">			p.setProperty(key, value);</span><br><span class="line">			fos = <span class="keyword">new</span> FileOutputStream(f);</span><br><span class="line">			p.store(fos, comment);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			LogUtils.e(e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			IOUtils.close(fis);</span><br><span class="line">			IOUtils.close(fos);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 根据值读取 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">readProperties</span><span class="params">(String filePath, String key, String defaultValue)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isEmpty(key) || StringUtils.isEmpty(filePath)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		String value = <span class="keyword">null</span>;</span><br><span class="line">		FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">		File f = <span class="keyword">new</span> File(filePath);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (!f.exists() || !f.isFile()) &#123;</span><br><span class="line">				f.createNewFile();</span><br><span class="line">			&#125;</span><br><span class="line">			fis = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line">			Properties p = <span class="keyword">new</span> Properties();</span><br><span class="line">			p.load(fis);</span><br><span class="line">			value = p.getProperty(key, defaultValue);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			LogUtils.e(e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			IOUtils.close(fis);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 把字符串键值对的map写入文件 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeMap</span><span class="params">(String filePath, Map&lt;String, String&gt; map, <span class="keyword">boolean</span> append, String comment)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (map == <span class="keyword">null</span> || map.size() == <span class="number">0</span> || StringUtils.isEmpty(filePath)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">		FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">		File f = <span class="keyword">new</span> File(filePath);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (!f.exists() || !f.isFile()) &#123;</span><br><span class="line">				f.createNewFile();</span><br><span class="line">			&#125;</span><br><span class="line">			Properties p = <span class="keyword">new</span> Properties();</span><br><span class="line">			<span class="keyword">if</span> (append) &#123;</span><br><span class="line">				fis = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line">				p.load(fis);<span class="comment">// 先读取文件，再把键值对追加到后面</span></span><br><span class="line">			&#125;</span><br><span class="line">			p.putAll(map);</span><br><span class="line">			fos = <span class="keyword">new</span> FileOutputStream(f);</span><br><span class="line">			p.store(fos, comment);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			LogUtils.e(e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			IOUtils.close(fis);</span><br><span class="line">			IOUtils.close(fos);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 把字符串键值对的文件读入map */</span></span><br><span class="line">	<span class="annotation">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>, <span class="string">"unchecked"</span>&#125;)</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, String&gt; readMap(String filePath, String defaultValue) &#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isEmpty(filePath)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Map&lt;String, String&gt; map = <span class="keyword">null</span>;</span><br><span class="line">		FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">		File f = <span class="keyword">new</span> File(filePath);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (!f.exists() || !f.isFile()) &#123;</span><br><span class="line">				f.createNewFile();</span><br><span class="line">			&#125;</span><br><span class="line">			fis = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line">			Properties p = <span class="keyword">new</span> Properties();</span><br><span class="line">			p.load(fis);</span><br><span class="line">			map = <span class="keyword">new</span> HashMap&lt;String, String&gt;((Map) p);<span class="comment">// 因为properties继承了map，所以直接通过p来构造一个map</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			LogUtils.e(e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			IOUtils.close(fis);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> map;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 改名 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">copy</span><span class="params">(String src, String des, <span class="keyword">boolean</span> delete)</span> </span>&#123;</span><br><span class="line">		File file = <span class="keyword">new</span> File(src);</span><br><span class="line">		<span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		File desFile = <span class="keyword">new</span> File(des);</span><br><span class="line">		FileInputStream in = <span class="keyword">null</span>;</span><br><span class="line">		FileOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			in = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">			out = <span class="keyword">new</span> FileOutputStream(desFile);</span><br><span class="line">			<span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">			<span class="keyword">int</span> count = -<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">while</span> ((count = in.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">				out.write(buffer, <span class="number">0</span>, count);</span><br><span class="line">				out.flush();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			LogUtils.e(e);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			IOUtils.close(in);</span><br><span class="line">			IOUtils.close(out);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (delete) &#123;</span><br><span class="line">			file.delete();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="读取本地缓存">读取本地缓存</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">loadLocal</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//如果发现文件过期,就不去使用本地的缓存</span></span><br><span class="line">       String dir = FileUtils.getCacheDir();<span class="comment">//获取缓存所在文件夹</span></span><br><span class="line">       File file = <span class="keyword">new</span> File(dir, <span class="string">"home_"</span> + index);</span><br><span class="line">       BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           FileReader fr = <span class="keyword">new</span> FileReader(file);</span><br><span class="line">           br = <span class="keyword">new</span> BufferedReader(fr);</span><br><span class="line">           <span class="keyword">long</span> outOfDate = Long.parseLong(br.readLine());</span><br><span class="line">           <span class="keyword">if</span> (System.currentTimeMillis() &gt; outOfDate) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               String str;</span><br><span class="line">               StringWriter sw = <span class="keyword">null</span>;</span><br><span class="line">               <span class="keyword">while</span> ((str = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   sw = <span class="keyword">new</span> StringWriter();</span><br><span class="line">                   sw.write(str);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> sw.toString();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (br != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   br.close();</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="json解析">json解析</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;AppInfo&gt; <span class="title">parserJson</span><span class="params">(String json)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       List&lt;AppInfo&gt; appInfos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           JSONObject jsonObject = <span class="keyword">new</span> JSONObject(json);</span><br><span class="line">           JSONArray jsonArray = jsonObject.getJSONArray(<span class="string">"list"</span>);</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jsonArray.length(); i++) &#123;</span><br><span class="line">               JSONObject object = jsonArray.getJSONObject(i);</span><br><span class="line">               <span class="keyword">long</span> id = object.getLong(<span class="string">"id"</span>);</span><br><span class="line">               String name = object.getString(<span class="string">"name"</span>);</span><br><span class="line">               String packageName = object.getString(<span class="string">"packageName"</span>);</span><br><span class="line">               String iconUrl = object.getString(<span class="string">"iconUrl"</span>);</span><br><span class="line">               <span class="keyword">float</span> stars = Float.parseFloat(object.getString(<span class="string">"stars"</span>));</span><br><span class="line">               String downloadUrl = object.getString(<span class="string">"downloadUrl"</span>);</span><br><span class="line">               <span class="keyword">long</span> size = object.getLong(<span class="string">"size"</span>);</span><br><span class="line">               String des = object.getString(<span class="string">"des"</span>);</span><br><span class="line">               AppInfo info = <span class="keyword">new</span> AppInfo(id, name, packageName,</span><br><span class="line">                       iconUrl, stars, downloadUrl, des, size);</span><br><span class="line">               appInfos.add(info);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> appInfos;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>没有使用任何的框架。</p>
<h2 id="布局的搭建">布局的搭建</h2><p>两点,一是adapter,一是xml文件。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">FrameLayout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">RelativeLayout</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"113dp"</span></span><br><span class="line">        <span class="attribute">android:layout_marginLeft</span>=<span class="value">"8dp"</span></span><br><span class="line">        <span class="attribute">android:layout_marginRight</span>=<span class="value">"8dp"</span></span><br><span class="line">        <span class="attribute">android:background</span>=<span class="value">"@drawable/list_item_bg"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">RelativeLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/item_top"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"72dp"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">ImageView</span></span><br><span class="line">                <span class="attribute">android:id</span>=<span class="value">"@+id/item_icon"</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"48dp"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"48dp"</span></span><br><span class="line">                <span class="attribute">android:layout_centerVertical</span>=<span class="value">"true"</span></span><br><span class="line">                <span class="attribute">android:layout_marginLeft</span>=<span class="value">"8dp"</span></span><br><span class="line">                <span class="attribute">android:layout_marginRight</span>=<span class="value">"8dp"</span></span><br><span class="line">                <span class="attribute">android:src</span>=<span class="value">"@drawable/ic_default"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">RelativeLayout</span></span><br><span class="line">                <span class="attribute">android:id</span>=<span class="value">"@+id/item_action"</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"70dp"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">                <span class="attribute">android:layout_alignParentRight</span>=<span class="value">"true"</span></span><br><span class="line">                <span class="attribute">android:gravity</span>=<span class="value">"center"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="title">FrameLayout</span></span><br><span class="line">                    <span class="attribute">android:id</span>=<span class="value">"@+id/action_progress"</span></span><br><span class="line">                    <span class="attribute">android:layout_centerHorizontal</span>=<span class="value">"true"</span></span><br><span class="line">                    <span class="attribute">android:layout_width</span>=<span class="value">"27dp"</span></span><br><span class="line">                    <span class="attribute">android:layout_height</span>=<span class="value">"27dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                    <span class="attribute">android:id</span>=<span class="value">"@+id/action_txt"</span></span><br><span class="line">                    <span class="attribute">android:layout_width</span>=<span class="value">"fill_parent"</span></span><br><span class="line">                    <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                    <span class="attribute">android:layout_below</span>=<span class="value">"@id/action_progress"</span></span><br><span class="line">                    <span class="attribute">android:layout_marginTop</span>=<span class="value">"5dp"</span></span><br><span class="line">                    <span class="attribute">android:ellipsize</span>=<span class="value">"end"</span></span><br><span class="line">                    <span class="attribute">android:gravity</span>=<span class="value">"center"</span></span><br><span class="line">                    <span class="attribute">android:singleLine</span>=<span class="value">"true"</span></span><br><span class="line">                    <span class="attribute">android:textColor</span>=<span class="value">"#ff7a7a7a"</span></span><br><span class="line">                    <span class="attribute">android:textSize</span>=<span class="value">"12dp"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">RelativeLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">RelativeLayout</span></span><br><span class="line">                <span class="attribute">android:id</span>=<span class="value">"@+id/item_content"</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_centerVertical</span>=<span class="value">"true"</span></span><br><span class="line">                <span class="attribute">android:layout_toLeftOf</span>=<span class="value">"@id/item_action"</span></span><br><span class="line">                <span class="attribute">android:layout_toRightOf</span>=<span class="value">"@id/item_icon"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                    <span class="attribute">android:id</span>=<span class="value">"@+id/item_title"</span></span><br><span class="line">                    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">                    <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                    <span class="attribute">android:ellipsize</span>=<span class="value">"end"</span></span><br><span class="line">                    <span class="attribute">android:singleLine</span>=<span class="value">"true"</span></span><br><span class="line">                    <span class="attribute">android:textColor</span>=<span class="value">"#ff333333"</span></span><br><span class="line">                    <span class="attribute">android:textSize</span>=<span class="value">"16dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="title">RatingBar</span></span><br><span class="line">                    <span class="attribute">android:id</span>=<span class="value">"@+id/item_rating"</span></span><br><span class="line">                    <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                    <span class="attribute">android:layout_height</span>=<span class="value">"14dp"</span></span><br><span class="line">                    <span class="attribute">android:layout_below</span>=<span class="value">"@id/item_title"</span></span><br><span class="line">                    <span class="attribute">android:layout_marginBottom</span>=<span class="value">"2dp"</span></span><br><span class="line">                    <span class="attribute">android:layout_marginTop</span>=<span class="value">"2dp"</span></span><br><span class="line">                    <span class="attribute">android:isIndicator</span>=<span class="value">"true"</span></span><br><span class="line">                    <span class="attribute">android:progressDrawable</span>=<span class="value">"@drawable/ratingbar_small"</span></span><br><span class="line">                    <span class="attribute">android:rating</span>=<span class="value">"2.5"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                    <span class="attribute">android:id</span>=<span class="value">"@+id/item_size"</span></span><br><span class="line">                    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">                    <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                    <span class="attribute">android:layout_below</span>=<span class="value">"@id/item_rating"</span></span><br><span class="line">                    <span class="attribute">android:singleLine</span>=<span class="value">"true"</span></span><br><span class="line">                    <span class="attribute">android:textColor</span>=<span class="value">"#ff7a7a7a"</span></span><br><span class="line">                    <span class="attribute">android:textSize</span>=<span class="value">"12dp"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">RelativeLayout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">RelativeLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">View</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/item_divider"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"1dp"</span></span><br><span class="line">            <span class="attribute">android:layout_below</span>=<span class="value">"@id/item_top"</span></span><br><span class="line">            <span class="attribute">android:layout_marginLeft</span>=<span class="value">"8dp"</span></span><br><span class="line">            <span class="attribute">android:layout_marginRight</span>=<span class="value">"8dp"</span></span><br><span class="line">            <span class="attribute">android:background</span>=<span class="value">"@color/item_divider"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/item_bottom"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_below</span>=<span class="value">"@id/item_divider"</span></span><br><span class="line">            <span class="attribute">android:layout_marginLeft</span>=<span class="value">"12dp"</span></span><br><span class="line">            <span class="attribute">android:layout_marginRight</span>=<span class="value">"12dp"</span></span><br><span class="line">            <span class="attribute">android:ellipsize</span>=<span class="value">"end"</span></span><br><span class="line">            <span class="attribute">android:gravity</span>=<span class="value">"center_vertical"</span></span><br><span class="line">            <span class="attribute">android:singleLine</span>=<span class="value">"true"</span></span><br><span class="line">            <span class="attribute">android:textColor</span>=<span class="value">"#ff717171"</span></span><br><span class="line">            <span class="attribute">android:textSize</span>=<span class="value">"14dp"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">RelativeLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>至于这里为什么外层加了一层帧布局,与ListView的item的高度有关。</p>
<h2 id="加载界面">加载界面</h2><p>其他的都很简单,就是图片的处理难点。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.text.format.Formatter;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.BaseAdapter;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"><span class="keyword">import</span> android.widget.RatingBar;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.BitmapUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.AppInfo;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.http.HttpHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.BitmapHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.UIUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/2.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;AppInfo&gt; appInfos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HomeAdapter</span><span class="params">(List&lt;AppInfo&gt; appInfos, Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.appInfos = appInfos;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> appInfos.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> appInfos.get(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        ViewHolder viewHolder;</span><br><span class="line">        <span class="keyword">if</span> (convertView == <span class="keyword">null</span>)&#123;</span><br><span class="line">            convertView = View.inflate(UIUtils.getContext(), R.layout.list_item,<span class="keyword">null</span>);</span><br><span class="line">            viewHolder = <span class="keyword">new</span> ViewHolder();</span><br><span class="line">            viewHolder.item_icon = (ImageView) convertView.findViewById(R.id.item_icon);</span><br><span class="line">            viewHolder.item_title = (TextView) convertView.findViewById(R.id.item_title);</span><br><span class="line">            viewHolder.item_size = (TextView) convertView.findViewById(R.id.item_size);</span><br><span class="line">            viewHolder.item_bottom = (TextView) convertView.findViewById(R.id.item_bottom);</span><br><span class="line">            viewHolder.item_rating = (RatingBar) convertView.findViewById(R.id.item_rating);</span><br><span class="line">            convertView.setTag(viewHolder);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           viewHolder= (ViewHolder) convertView.getTag();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        AppInfo appInfo = appInfos.get(position);</span><br><span class="line"></span><br><span class="line">        viewHolder.item_title.setText(appInfo.getName());</span><br><span class="line">        String size = Formatter.formatFileSize(UIUtils.getContext(), appInfo.getSize());</span><br><span class="line">        viewHolder.item_size.setText(size);</span><br><span class="line">        viewHolder.item_bottom.setText(appInfo.getDes());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> stars = appInfo.getStars();</span><br><span class="line">        viewHolder.item_rating.setRating(stars);</span><br><span class="line">       <span class="comment">// Glide.with(UIUtils.getContext()).load(HttpHelper.URL + "image?name=" + appInfo.getIconUrl()).into(viewHolder.item_icon);</span></span><br><span class="line"></span><br><span class="line">        BitmapUtils bitmapUtils = BitmapHelper.getInstance();</span><br><span class="line">        bitmapUtils.display(viewHolder.item_icon, HttpHelper.URL + <span class="string">"image?name="</span> + appInfo.getIconUrl());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> convertView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span></span>&#123;</span><br><span class="line">        ImageView item_icon;</span><br><span class="line">        TextView item_title,item_size,item_bottom;</span><br><span class="line">        RatingBar item_rating;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>快速滑动的时候,停止加载：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.fragment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.ListView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.BitmapUtils;</span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.bitmap.PauseOnScrollListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.adapter.HomeAdapter;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.AppInfo;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.protocol.HomeProtocol;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.BitmapHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.view.LoadingPage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/1.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeFragment</span> <span class="keyword">extends</span> <span class="title">BaseFragment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = HomeFragment.class.getSimpleName();</span><br><span class="line"></span><br><span class="line">    List&lt;AppInfo&gt; appInfos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HomeAdapter adapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BitmapUtils bitmapUtils = BitmapHelper.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> View <span class="title">createSuccessView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ListView listView = <span class="keyword">new</span> ListView(getActivity());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (adapter == <span class="keyword">null</span>)&#123;</span><br><span class="line">            adapter = <span class="keyword">new</span> HomeAdapter(appInfos,getActivity());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        listView.setAdapter(adapter);</span><br><span class="line"></span><br><span class="line">        bitmapUtils.configDefaultLoadFailedImage(R.drawable.ic_default);</span><br><span class="line">        bitmapUtils.configDefaultLoadingImage(R.drawable.ic_default);</span><br><span class="line"></span><br><span class="line">        listView.setOnScrollListener(<span class="keyword">new</span> PauseOnScrollListener</span><br><span class="line">                (bitmapUtils,<span class="keyword">false</span>,<span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> listView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> LoadingPage.<span class="function">LoadResult <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HomeProtocol protocol = <span class="keyword">new</span> HomeProtocol();</span><br><span class="line">        appInfos = protocol.load(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">/*for (AppInfo info :</span><br><span class="line">                appInfos) &#123;</span><br><span class="line">            System.out.println(info.toString());</span><br><span class="line"></span><br><span class="line">        &#125;*/</span></span><br><span class="line">        <span class="keyword">return</span> checkData(appInfos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoadingPage.<span class="function">LoadResult <span class="title">checkData</span><span class="params">(List&lt;AppInfo&gt; appInfos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appInfos == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> LoadingPage.LoadResult.error;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (appInfos.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> LoadingPage.LoadResult.empty;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> LoadingPage.LoadResult.success;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">        show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>辅助类：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.BitmapUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BitmapHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BitmapUtils bitmapUtils;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BitmapUtils <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmapUtils == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//缓存图片的路径</span></span><br><span class="line">            <span class="comment">//加载图片  消耗最多百分比的内存</span></span><br><span class="line">            bitmapUtils = <span class="keyword">new</span> BitmapUtils(UIUtils.getContext(),</span><br><span class="line">                    FileUtils.getIconDir(),<span class="number">0.5f</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bitmapUtils;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">BitmapHelper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终实现的效果如下：<br><img src="http://7xljei.com1.z0.glb.clouddn.com/uiframe.gif" alt="效果图"></p>
<h1 id="2015-10-03上午">2015.10.03上午</h1><h2 id="抽取BaseProtocol">抽取BaseProtocol</h2><p>前面写了HomeProtocol,现在要完成的是专题界面,但是发现基本逻辑一致,于是进行抽取到基类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.protocol;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.http.HttpHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.FileUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseProtocol</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">load</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        String json = loadLocal(index);</span><br><span class="line">        <span class="keyword">if</span> (json == <span class="keyword">null</span>) &#123;</span><br><span class="line">            json = loadServer(index);</span><br><span class="line">            <span class="keyword">if</span> (json != <span class="keyword">null</span>) &#123;</span><br><span class="line">                saveLocal(json, index);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="comment">/*else&#123;</span><br><span class="line">            Log.e(TAG, "load " +"复用本地缓存了");</span><br><span class="line">        &#125;*/</span></span><br><span class="line">        <span class="keyword">if</span> (json != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> parserJson(json);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 解析json</span><br><span class="line">     * <span class="doctag">@param</span> json</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> T <span class="title">parserJson</span><span class="params">(String json)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">loadLocal</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果发现文件过期,就不去使用本地的缓存</span></span><br><span class="line">        String dir = FileUtils.getCacheDir();<span class="comment">//获取缓存所在文件夹</span></span><br><span class="line">        File file = <span class="keyword">new</span> File(dir, getKey() + <span class="string">"_"</span> + index);</span><br><span class="line">        BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileReader fr = <span class="keyword">new</span> FileReader(file);</span><br><span class="line">            br = <span class="keyword">new</span> BufferedReader(fr);</span><br><span class="line">            <span class="keyword">long</span> outOfDate = Long.parseLong(br.readLine());</span><br><span class="line">            <span class="keyword">if</span> (System.currentTimeMillis() &gt; outOfDate) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                String str;</span><br><span class="line">                StringWriter sw = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">while</span> ((str = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    sw = <span class="keyword">new</span> StringWriter();</span><br><span class="line">                    sw.write(str);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> sw.toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (br != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    br.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveLocal</span><span class="params">(String json, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//在第一行写一个过期的时间</span></span><br><span class="line">        String dir = FileUtils.getCacheDir();</span><br><span class="line">        File file = <span class="keyword">new</span> File(dir, getKey() + <span class="string">"_"</span> + index);</span><br><span class="line">        BufferedWriter bw = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileWriter fileWriter = <span class="keyword">new</span> FileWriter(file);</span><br><span class="line">            bw = <span class="keyword">new</span> BufferedWriter(fileWriter);</span><br><span class="line">            bw.write(System.currentTimeMillis() + <span class="number">1000</span> * <span class="number">100</span> + <span class="string">""</span>);</span><br><span class="line">            bw.newLine();</span><br><span class="line">            bw.write(json);</span><br><span class="line">            bw.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (bw != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    bw.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">loadServer</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*xUtils框架请求由于Android6.0删除HttpClient会导致报错</span><br><span class="line">        HttpUtils httpUtils = new HttpUtils();</span><br><span class="line">        try &#123;</span><br><span class="line">            ResponseStream responseStream = httpUtils.sendSync(HttpRequest.HttpMethod.GET,</span><br><span class="line">                    "http://127.0.0.1:8090/home");</span><br><span class="line">            System.out.println(responseStream.toString());</span><br><span class="line">        &#125; catch (HttpException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">        AsyncHttpClient asyncHttpClient = new AsyncHttpClient();</span><br><span class="line">        asyncHttpClient.get("http://127.0.0.1:8090/home" + "?index=" + index, new AsyncHttpResponseHandler() &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onSuccess(int statusCode, Header[] headers, byte[] responseBody) &#123;</span><br><span class="line"></span><br><span class="line">                String response = new String(responseBody);</span><br><span class="line">                Log.e(TAG, "onSuccess " + response);</span><br><span class="line">                System.out.println(response);</span><br><span class="line">                Message message = Message.obtain();</span><br><span class="line">                message.obj = response;</span><br><span class="line">                sendMessage(message);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onFailure(int statusCode, Header[] headers, byte[] responseBody, Throwable error) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">        */</span></span><br><span class="line"></span><br><span class="line">        HttpHelper.HttpResult httpResult = HttpHelper.get(HttpHelper.URL + getKey() + <span class="string">"?index="</span> +  index);</span><br><span class="line"></span><br><span class="line">        String json = httpResult.getString();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 访问网络关键字</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getKey</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的话,HomeProtocol就成了这样：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.protocol;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONException;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.AppInfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/2.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeProtocol</span> <span class="keyword">extends</span> <span class="title">BaseProtocol</span>&lt;<span class="title">List</span>&lt;<span class="title">AppInfo</span>&gt;&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;AppInfo&gt; <span class="title">parserJson</span><span class="params">(String json)</span> </span>&#123;</span><br><span class="line">        List&lt;AppInfo&gt; appInfos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JSONObject jsonObject = <span class="keyword">new</span> JSONObject(json);</span><br><span class="line">            JSONArray jsonArray = jsonObject.getJSONArray(<span class="string">"list"</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jsonArray.length(); i++) &#123;</span><br><span class="line">                JSONObject object = jsonArray.getJSONObject(i);</span><br><span class="line">                <span class="keyword">long</span> id = object.getLong(<span class="string">"id"</span>);</span><br><span class="line">                String name = object.getString(<span class="string">"name"</span>);</span><br><span class="line">                String packageName = object.getString(<span class="string">"packageName"</span>);</span><br><span class="line">                String iconUrl = object.getString(<span class="string">"iconUrl"</span>);</span><br><span class="line">                <span class="keyword">float</span> stars = Float.parseFloat(object.getString(<span class="string">"stars"</span>));</span><br><span class="line">                String downloadUrl = object.getString(<span class="string">"downloadUrl"</span>);</span><br><span class="line">                <span class="keyword">long</span> size = object.getLong(<span class="string">"size"</span>);</span><br><span class="line">                String des = object.getString(<span class="string">"des"</span>);</span><br><span class="line">                AppInfo info = <span class="keyword">new</span> AppInfo(id, name, packageName,</span><br><span class="line">                        iconUrl, stars, downloadUrl, des, size);</span><br><span class="line">                appInfos.add(info);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> appInfos;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"home"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看起来也爽了很多。</p>
<p>再者是SubjectProtocol：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.protocol;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONException;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.SubjectInfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubjectProtocol</span> <span class="keyword">extends</span> <span class="title">BaseProtocol</span>&lt;<span class="title">List</span>&lt;<span class="title">SubjectInfo</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;SubjectInfo&gt; <span class="title">parserJson</span><span class="params">(String json)</span> </span>&#123;</span><br><span class="line">        List&lt;SubjectInfo&gt; subjectInfos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JSONArray jsonArray = <span class="keyword">new</span> JSONArray(json);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jsonArray.length(); i++) &#123;</span><br><span class="line">                JSONObject jsonObject = jsonArray.getJSONObject(i);</span><br><span class="line">                String des = jsonObject.getString(<span class="string">"des"</span>);</span><br><span class="line">                String url = jsonObject.getString(<span class="string">"url"</span>);</span><br><span class="line">                SubjectInfo subjectInfo = <span class="keyword">new</span> SubjectInfo(des, url);</span><br><span class="line">                subjectInfos.add(subjectInfo);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> subjectInfos;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"subject"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果不进行抽取,代码会重复很多。</p>
<h2 id="专题界面完成">专题界面完成</h2><p>首先是adapter:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.BaseAdapter;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.BitmapUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.SubjectInfo;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.http.HttpHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.BitmapHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.UIUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubjectAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;SubjectInfo&gt; subjectInfos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubjectAdapter</span><span class="params">(List&lt;SubjectInfo&gt; subjectInfos, Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subjectInfos = subjectInfos;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> subjectInfos.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> subjectInfos.get(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        ViewHolder viewHolder;</span><br><span class="line">        <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            convertView = View.inflate(UIUtils.getContext(), R.layout.subject_item, <span class="keyword">null</span>);</span><br><span class="line">            viewHolder = <span class="keyword">new</span> ViewHolder();</span><br><span class="line">            viewHolder.item_icon = (ImageView) convertView.findViewById(R.id.item_icon);</span><br><span class="line">            viewHolder.item_txt = (TextView) convertView.findViewById(R.id.item_txt);</span><br><span class="line">            convertView.setTag(viewHolder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            viewHolder = (ViewHolder) convertView.getTag();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SubjectInfo subjectInfo = subjectInfos.get(position);</span><br><span class="line"></span><br><span class="line">        String des = subjectInfo.getDes();</span><br><span class="line">        String url = subjectInfo.getUrl();</span><br><span class="line"></span><br><span class="line">        viewHolder.item_txt.setText(des);</span><br><span class="line">        BitmapUtils bitmapUtils = BitmapHelper.getInstance();</span><br><span class="line">        bitmapUtils.display(viewHolder.item_icon, HttpHelper.URL + <span class="string">"image?name="</span> + url);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> convertView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">        ImageView item_icon;</span><br><span class="line">        TextView item_txt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后是条目的布局：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">FrameLayout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">             <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">             <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">RelativeLayout</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:layout_marginLeft</span>=<span class="value">"9dip"</span></span><br><span class="line">            <span class="attribute">android:layout_marginRight</span>=<span class="value">"9dip"</span></span><br><span class="line">            <span class="attribute">android:background</span>=<span class="value">"@drawable/list_item_bg"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">me.chenfuduo.mymarketpro.view.RatioLayout</span> <span class="attribute">xmlns:chenfuduo</span>=<span class="value">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="line">                                         <span class="attribute">android:id</span>=<span class="value">"@+id/icon_wrapper"</span></span><br><span class="line">                                         <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">                                         <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                                         <span class="attribute">android:padding</span>=<span class="value">"5dp"</span></span><br><span class="line">                                         <span class="attribute">chenfuduo:ratio</span>=<span class="value">"2.43"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">ImageView</span></span><br><span class="line">                    <span class="attribute">android:src</span>=<span class="value">"@drawable/ic_default"</span></span><br><span class="line">                    <span class="attribute">android:id</span>=<span class="value">"@+id/item_icon"</span></span><br><span class="line">                    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">                    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">                    <span class="attribute">android:scaleType</span>=<span class="value">"fitCenter"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">me.chenfuduo.mymarketpro.view.RatioLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                <span class="attribute">android:id</span>=<span class="value">"@+id/item_txt"</span></span><br><span class="line">                <span class="attribute">style</span>=<span class="value">"@style/TitleStyle"</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">                <span class="attribute">android:layout_below</span>=<span class="value">"@id/icon_wrapper"</span></span><br><span class="line">                <span class="attribute">android:ellipsize</span>=<span class="value">"end"</span></span><br><span class="line">                <span class="attribute">android:gravity</span>=<span class="value">"center_vertical"</span></span><br><span class="line">                <span class="attribute">android:paddingBottom</span>=<span class="value">"5dp"</span></span><br><span class="line">                <span class="attribute">android:paddingLeft</span>=<span class="value">"5dp"</span></span><br><span class="line">                <span class="attribute">android:paddingRight</span>=<span class="value">"5dp"</span></span><br><span class="line">                <span class="attribute">android:singleLine</span>=<span class="value">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">RelativeLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>外层嵌套FrameLayout的原理和上面说的一致。</p>
<p>至于这里的自定义控件,这里先不做说明。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.fragment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.ListView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.bitmap.PauseOnScrollListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.adapter.SubjectAdapter;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.SubjectInfo;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.protocol.SubjectProtocol;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.UIUtils;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.view.LoadingPage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/1.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubjectFragment</span> <span class="keyword">extends</span> <span class="title">BaseFragment</span> </span>&#123;</span><br><span class="line">    List&lt;SubjectInfo&gt; subjectInfos;</span><br><span class="line"></span><br><span class="line">    SubjectAdapter adapter;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> LoadingPage.<span class="function">LoadResult <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        SubjectProtocol subjectProtocol = <span class="keyword">new</span> SubjectProtocol();</span><br><span class="line">        subjectInfos = subjectProtocol.load(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> checkData(subjectInfos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> View <span class="title">createSuccessView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ListView listView = <span class="keyword">new</span> ListView(UIUtils.getContext());</span><br><span class="line">        <span class="keyword">if</span> (adapter == <span class="keyword">null</span>)&#123;</span><br><span class="line">            adapter = <span class="keyword">new</span> SubjectAdapter(subjectInfos,UIUtils.getContext());</span><br><span class="line">        &#125;</span><br><span class="line">        listView.setAdapter(adapter);</span><br><span class="line">        bitmapUtils.configDefaultLoadFailedImage(R.drawable.ic_default);</span><br><span class="line">        bitmapUtils.configDefaultLoadingImage(R.drawable.ic_default);</span><br><span class="line"></span><br><span class="line">        listView.setOnScrollListener(<span class="keyword">new</span> PauseOnScrollListener</span><br><span class="line">                (bitmapUtils, <span class="keyword">false</span>, <span class="keyword">true</span>));</span><br><span class="line">        <span class="keyword">return</span> listView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么完成的效果图如下：</p>
<p><img src="http://7xljei.com1.z0.glb.clouddn.com/subjectui.gif" alt="效果图"></p>
<h2 id="BaseListView">BaseListView</h2><p>ListView有些样式是一样的,对其进行抽取。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.view;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.widget.ListView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.UIUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseListView</span> <span class="keyword">extends</span> <span class="title">ListView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseListView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseListView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseListView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//点击条目的颜色</span></span><br><span class="line">        <span class="keyword">this</span>.setSelector(R.drawable.nothing);</span><br><span class="line">        <span class="comment">//拖拽的颜色</span></span><br><span class="line">        <span class="keyword">this</span>.setCacheColorHint(R.drawable.nothing);</span><br><span class="line">        <span class="comment">//每个条目的分割线</span></span><br><span class="line">        <span class="keyword">this</span>.setDivider(UIUtils.getDrawable(R.drawable.nothing));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="2015-10-03下午">2015.10.03下午</h1><h2 id="抽取Adapter和ViewHolder">抽取Adapter和ViewHolder</h2><p>下面是抽取的步骤：</p>
<blockquote>
<ul>
<li>抽取Adapter 共性的方法</li>
<li>把getView方法里 和holder相关的逻辑 摘取到Holder代码中</li>
<li>把Holder 相关的代码 抽取到BaseHolder中</li>
<li>把adapter 中getVIew 方法 抽取到了DefaultAdpater中,<br>其中每个子类getView方法中holder不太一样,所以定义了抽象方法getHolder 要求子类去实现holder。</li>
</ul>
</blockquote>
<p>那么:<br>DefaultAdapter:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.BaseAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.holder.BaseViewHolder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">Data</span>&gt; <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Data&gt; datas;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultAdapter</span><span class="params">(List&lt;Data&gt; datas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.datas = datas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datas.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datas.get(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        BaseViewHolder&lt;Data&gt; viewHolder;</span><br><span class="line">        <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            viewHolder = getHolder();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            viewHolder = (BaseViewHolder&lt;Data&gt;) convertView.getTag();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Data data = datas.get(position);</span><br><span class="line"></span><br><span class="line">        viewHolder.setData(data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> viewHolder.getConvertView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> BaseViewHolder&lt;Data&gt; <span class="title">getHolder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>BaseViewHolder:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.holder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseViewHolder</span>&lt;<span class="title">Data</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    View convertView;</span><br><span class="line"></span><br><span class="line">    Data data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseViewHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        convertView =  initView();</span><br><span class="line">        convertView.setTag(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> View <span class="title">initView</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(Data data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        refreshView(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getConvertView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> convertView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">(Data data)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HomeAdapter:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.text.format.Formatter;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"><span class="keyword">import</span> android.widget.RatingBar;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.BitmapUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.AppInfo;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.holder.BaseViewHolder;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.http.HttpHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.BitmapHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.UIUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/2.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeAdapter</span> <span class="keyword">extends</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">AppInfo</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HomeAdapter</span><span class="params">(List&lt;AppInfo&gt; appInfos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(appInfos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BaseViewHolder&lt;AppInfo&gt; <span class="title">getHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ViewHolder viewHolder = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (viewHolder == <span class="keyword">null</span>)&#123;</span><br><span class="line">            viewHolder = <span class="keyword">new</span> ViewHolder();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> viewHolder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> <span class="keyword">extends</span> <span class="title">BaseViewHolder</span>&lt;<span class="title">AppInfo</span>&gt;</span>&#123;</span><br><span class="line">        ImageView item_icon;</span><br><span class="line">        TextView item_title, item_size, item_bottom;</span><br><span class="line">        RatingBar item_rating;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            View convertView = View.inflate(UIUtils.getContext(), R.layout.list_item, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.item_icon = (ImageView) convertView.findViewById(R.id.item_icon);</span><br><span class="line">            <span class="keyword">this</span>.item_title = (TextView) convertView.findViewById(R.id.item_title);</span><br><span class="line">            <span class="keyword">this</span>.item_size = (TextView) convertView.findViewById(R.id.item_size);</span><br><span class="line">            <span class="keyword">this</span>.item_bottom = (TextView) convertView.findViewById(R.id.item_bottom);</span><br><span class="line">            <span class="keyword">this</span>.item_rating = (RatingBar) convertView.findViewById(R.id.item_rating);</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">(AppInfo data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.item_title.setText(data.getName());</span><br><span class="line">            String size = Formatter.formatFileSize(UIUtils.getContext(), data.getSize());</span><br><span class="line">            <span class="keyword">this</span>.item_size.setText(size);</span><br><span class="line">            <span class="keyword">this</span>.item_bottom.setText(data.getDes());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">float</span> stars = data.getStars();</span><br><span class="line">            <span class="keyword">this</span>.item_rating.setRating(stars);</span><br><span class="line">            <span class="comment">// Glide.with(UIUtils.getContext()).load(HttpHelper.URL + "image?name=" + appInfo.getIconUrl()).into(viewHolder.item_icon);</span></span><br><span class="line"></span><br><span class="line">            BitmapUtils bitmapUtils = BitmapHelper.getInstance();</span><br><span class="line">            bitmapUtils.display(<span class="keyword">this</span>.item_icon, HttpHelper.URL + <span class="string">"image?name="</span> + data.getIconUrl());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SubjectAdapter:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.BitmapUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.SubjectInfo;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.holder.BaseViewHolder;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.http.HttpHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.BitmapHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.UIUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubjectAdapter</span> <span class="keyword">extends</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">SubjectInfo</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubjectAdapter</span><span class="params">(List&lt;SubjectInfo&gt; subjectInfos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(subjectInfos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BaseViewHolder&lt;SubjectInfo&gt; <span class="title">getHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ViewHolder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> <span class="keyword">extends</span> <span class="title">BaseViewHolder</span>&lt;<span class="title">SubjectInfo</span>&gt;</span>&#123;</span><br><span class="line">        ImageView item_icon;</span><br><span class="line">        TextView item_txt;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            View convertView = View.inflate(UIUtils.getContext(), R.layout.subject_item, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.item_icon = (ImageView) convertView.findViewById(R.id.item_icon);</span><br><span class="line">            <span class="keyword">this</span>.item_txt = (TextView) convertView.findViewById(R.id.item_txt);</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">(SubjectInfo data)</span> </span>&#123;</span><br><span class="line">            String des = data.getDes();</span><br><span class="line">            String url = data.getUrl();</span><br><span class="line">            <span class="keyword">this</span>.item_txt.setText(des);</span><br><span class="line">            BitmapUtils bitmapUtils = BitmapHelper.getInstance();</span><br><span class="line">            bitmapUtils.display(<span class="keyword">this</span>.item_icon, HttpHelper.URL + <span class="string">"image?name="</span> + url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> View <span class="title">createSuccessView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       BaseListView listView = <span class="keyword">new</span> BaseListView(getActivity());</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (adapter == <span class="keyword">null</span>)&#123;</span><br><span class="line">           adapter = <span class="keyword">new</span> HomeAdapter(appInfos);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       listView.setAdapter(adapter);</span><br><span class="line"></span><br><span class="line">       bitmapUtils.configDefaultLoadFailedImage(R.drawable.ic_default);</span><br><span class="line">       bitmapUtils.configDefaultLoadingImage(R.drawable.ic_default);</span><br><span class="line"></span><br><span class="line">       listView.setOnScrollListener(<span class="keyword">new</span> PauseOnScrollListener</span><br><span class="line">               (bitmapUtils,<span class="keyword">false</span>,<span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> listView;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="游戏和应用界面">游戏和应用界面</h2><p>游戏和应用界面两者完全一致。</p>
<p>首先看应用的。</p>
<p>AppProtocol:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.protocol;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONException;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.AppInfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppProtocol</span> <span class="keyword">extends</span> <span class="title">BaseProtocol</span>&lt;<span class="title">List</span>&lt;<span class="title">AppInfo</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;AppInfo&gt; <span class="title">parserJson</span><span class="params">(String json)</span> </span>&#123;</span><br><span class="line">        List&lt;AppInfo&gt; appInfos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JSONArray jsonArray = <span class="keyword">new</span> JSONArray(json);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jsonArray.length(); i++) &#123;</span><br><span class="line">                JSONObject object = jsonArray.getJSONObject(i);</span><br><span class="line">                <span class="keyword">long</span> id = object.getLong(<span class="string">"id"</span>);</span><br><span class="line">                String name = object.getString(<span class="string">"name"</span>);</span><br><span class="line">                String packageName = object.getString(<span class="string">"packageName"</span>);</span><br><span class="line">                String iconUrl = object.getString(<span class="string">"iconUrl"</span>);</span><br><span class="line">                <span class="keyword">float</span> stars = Float.parseFloat(object.getString(<span class="string">"stars"</span>));</span><br><span class="line">                String downloadUrl = object.getString(<span class="string">"downloadUrl"</span>);</span><br><span class="line">                <span class="keyword">long</span> size = object.getLong(<span class="string">"size"</span>);</span><br><span class="line">                String des = object.getString(<span class="string">"des"</span>);</span><br><span class="line">                AppInfo info = <span class="keyword">new</span> AppInfo(id, name, packageName,</span><br><span class="line">                        iconUrl, stars, downloadUrl, des, size);</span><br><span class="line">                appInfos.add(info);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> appInfos;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"app"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AppAdapter:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.text.format.Formatter;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"><span class="keyword">import</span> android.widget.RatingBar;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.BitmapUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.AppInfo;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.holder.BaseViewHolder;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.http.HttpHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.BitmapHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.UIUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppAdapter</span> <span class="keyword">extends</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">AppInfo</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppAdapter</span><span class="params">(List&lt;AppInfo&gt; appInfos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(appInfos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BaseViewHolder&lt;AppInfo&gt; <span class="title">getHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ViewHolder viewHolder = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (viewHolder == <span class="keyword">null</span>)&#123;</span><br><span class="line">            viewHolder = <span class="keyword">new</span> ViewHolder();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> viewHolder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> <span class="keyword">extends</span> <span class="title">BaseViewHolder</span>&lt;<span class="title">AppInfo</span>&gt;</span>&#123;</span><br><span class="line">        ImageView item_icon;</span><br><span class="line">        TextView item_title, item_size, item_bottom;</span><br><span class="line">        RatingBar item_rating;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            View convertView = View.inflate(UIUtils.getContext(), R.layout.list_item, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.item_icon = (ImageView) convertView.findViewById(R.id.item_icon);</span><br><span class="line">            <span class="keyword">this</span>.item_title = (TextView) convertView.findViewById(R.id.item_title);</span><br><span class="line">            <span class="keyword">this</span>.item_size = (TextView) convertView.findViewById(R.id.item_size);</span><br><span class="line">            <span class="keyword">this</span>.item_bottom = (TextView) convertView.findViewById(R.id.item_bottom);</span><br><span class="line">            <span class="keyword">this</span>.item_rating = (RatingBar) convertView.findViewById(R.id.item_rating);</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">(AppInfo data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.item_title.setText(data.getName());</span><br><span class="line">            String size = Formatter.formatFileSize(UIUtils.getContext(), data.getSize());</span><br><span class="line">            <span class="keyword">this</span>.item_size.setText(size);</span><br><span class="line">            <span class="keyword">this</span>.item_bottom.setText(data.getDes());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">float</span> stars = data.getStars();</span><br><span class="line">            <span class="keyword">this</span>.item_rating.setRating(stars);</span><br><span class="line">            <span class="comment">// Glide.with(UIUtils.getContext()).load(HttpHelper.URL + "image?name=" + appInfo.getIconUrl()).into(viewHolder.item_icon);</span></span><br><span class="line"></span><br><span class="line">            BitmapUtils bitmapUtils = BitmapHelper.getInstance();</span><br><span class="line">            bitmapUtils.display(<span class="keyword">this</span>.item_icon, HttpHelper.URL + <span class="string">"image?name="</span> + data.getIconUrl());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AppFragment:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.fragment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.bitmap.PauseOnScrollListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.adapter.AppAdapter;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.AppInfo;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.protocol.AppProtocol;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.view.BaseListView;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.view.LoadingPage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/1.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppFragment</span> <span class="keyword">extends</span> <span class="title">BaseFragment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = AppFragment.class.getSimpleName();</span><br><span class="line"></span><br><span class="line">    List&lt;AppInfo&gt; appInfos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AppAdapter adapter;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> LoadingPage.<span class="function">LoadResult <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AppProtocol appProtocol = <span class="keyword">new</span> AppProtocol();</span><br><span class="line">        appInfos = appProtocol.load(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> checkData(appInfos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> View <span class="title">createSuccessView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BaseListView listView = <span class="keyword">new</span> BaseListView(getActivity());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (adapter == <span class="keyword">null</span>)&#123;</span><br><span class="line">            adapter = <span class="keyword">new</span> AppAdapter(appInfos);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        listView.setAdapter(adapter);</span><br><span class="line"></span><br><span class="line">        bitmapUtils.configDefaultLoadFailedImage(R.drawable.ic_default);</span><br><span class="line">        bitmapUtils.configDefaultLoadingImage(R.drawable.ic_default);</span><br><span class="line"></span><br><span class="line">        listView.setOnScrollListener(<span class="keyword">new</span> PauseOnScrollListener</span><br><span class="line">                (bitmapUtils,<span class="keyword">false</span>,<span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> listView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>游戏和应用的实现原理完全一致,只是协议中的getKey()返回的是game而已。到这里,应用做成的效果如下：</p>
<p><img src="http://7xljei.com1.z0.glb.clouddn.com/gameandappui.gif" alt="效果图"></p>
<h1 id="2015-10-03晚上">2015.10.03晚上</h1><h2 id="MoreViewHolder(加载更多)">MoreViewHolder(加载更多)</h2><p>package me.chenfuduo.mymarketpro.holder;</p>
<p>import android.view.View;<br>import android.widget.RelativeLayout;</p>
<p>import me.chenfuduo.mymarketpro.R;<br>import me.chenfuduo.mymarketpro.utils.UIUtils;</p>
<p>/**</p>
<ul>
<li>Created by chenfuduo on 2015/10/3.<br>*/<br>public class MoreViewHolder extends BaseViewHolder<integer>{<br> public static final int HAS_NO_MORE = 0;<br> public static final int LOAD_ERROR = 1;<br> public static final int HAS_MORE = 2;</integer></li>
</ul>
<pre><code><span class="keyword">private</span> RelativeLayout rl_more_loading,rl_more_error;

<span class="annotation">@Override</span>
<span class="keyword">public</span> <span class="function">View <span class="title">initView</span><span class="params">()</span> </span>{
    View view = UIUtils.inflate(R.layout.load_more);
    rl_more_loading = (RelativeLayout) view.findViewById(R.id.rl_more_loading);
    rl_more_error = (RelativeLayout) view.findViewById(R.id.rl_more_error);
    <span class="keyword">return</span> view;
}


<span class="annotation">@Override</span>
<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">refreshView</span><span class="params">(Integer integer)</span> </span>{

}
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#37027;&#20040;&#22312;DefaultAdapter&#20013;&#65306;&#10;```java&#10; @Override&#10;    public View getView(int position, View convertView, ViewGroup parent) &#123;&#10;        BaseViewHolder viewHolder;&#10;        if (position == datas.size())&#123;//MoreHolder&#10;            viewHolder = getMoreViewHolder();&#10;            return viewHolder.getConvertView();&#10;        &#125;&#10;        if (convertView == null) &#123;&#10;            viewHolder = getHolder();//&#26222;&#36890;&#26465;&#30446;&#30340;holder&#10;        &#125; else &#123;&#10;            viewHolder = (BaseViewHolder) convertView.getTag();&#10;        &#125;&#10;&#10;&#10;        Data data = datas.get(position);&#10;&#10;        viewHolder.setData(data);&#10;&#10;        return viewHolder.getConvertView();&#10;    &#125;</span><br></pre></td></tr></table></figure></p>
<p>一运行,出现下面的效果：<br><img src="http://7xljei.com1.z0.glb.clouddn.com/errormoreloading.gif" alt="效果图"></p>
<p>也看到了上面出现了错误,日志如下：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">10-03 13:52:40.317  31923-31923/me.chenfuduo.mymarketpro E/AndroidRuntime&#65109; FATAL EXCEPTION: main&#10;    java.lang.ClassCastException: me.chenfuduo.mymarketpro.bean.AppInfo cannot be cast to java.lang.Integer&#10;            at me.chenfuduo.mymarketpro.holder.MoreViewHolder.refreshView(MoreViewHolder.java:12)&#10;            at me.chenfuduo.mymarketpro.holder.BaseViewHolder.setData(BaseViewHolder.java:23)&#10;            at me.chenfuduo.mymarketpro.adapter.DefaultAdapter.getView(DefaultAdapter.java:55)</span><br></pre></td></tr></table></figure></p>
<h2 id="ListView多类型复用">ListView多类型复用</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.BaseAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.holder.BaseViewHolder;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.holder.MoreViewHolder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">Data</span>&gt; <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Data&gt; datas;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultAdapter</span><span class="params">(List&lt;Data&gt; datas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.datas = datas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_ITEM = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MORE_ITEM = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datas.size() + <span class="number">1</span>;<span class="comment">//+1是因为加载更多</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datas.get(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (position == datas.size()) &#123; <span class="comment">// 当前是最后一个条目</span></span><br><span class="line">            <span class="keyword">return</span> MORE_ITEM;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getInnerItemViewType(position); <span class="comment">// 如果不是最后一个条目 返回默认类型</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getInnerItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT_ITEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getViewTypeCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getViewTypeCount() + <span class="number">1</span>;<span class="comment">//加载更多  2种不同类型</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        BaseViewHolder viewHolder = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (getItemViewType(position)) &#123;</span><br><span class="line">            <span class="keyword">case</span> MORE_ITEM:</span><br><span class="line">                <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    viewHolder = getMoreViewHolder();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    viewHolder = (BaseViewHolder) convertView.getTag();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DEFAULT_ITEM:</span><br><span class="line">                <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    viewHolder = getHolder();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    viewHolder = (BaseViewHolder) convertView.getTag();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (position &lt; datas.size()) &#123;</span><br><span class="line">                    viewHolder.setData(datas.get(position));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> viewHolder.getConvertView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MoreViewHolder holder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> BaseViewHolder <span class="title">getMoreViewHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(holder!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> holder;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            holder=<span class="keyword">new</span> MoreViewHolder();</span><br><span class="line">            <span class="keyword">return</span> holder;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> BaseViewHolder&lt;Data&gt; <span class="title">getHolder</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ok,那么现在上面出现的错误信息就会消失了.</p>
<p>注意两个新的api。</p>
<h2 id="加载更多的业务逻辑">加载更多的业务逻辑</h2><p>MoreViewHolder交给adapter去处理：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.holder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.RelativeLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.adapter.DefaultAdapter;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.UIUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MoreViewHolder</span> <span class="keyword">extends</span> <span class="title">BaseViewHolder</span>&lt;<span class="title">Integer</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HAS_NO_MORE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOAD_ERROR = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HAS_MORE = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RelativeLayout rl_more_loading,rl_more_error;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        View view = UIUtils.inflate(R.layout.load_more);</span><br><span class="line">        rl_more_loading = (RelativeLayout) view.findViewById(R.id.rl_more_loading);</span><br><span class="line">        rl_more_error = (RelativeLayout) view.findViewById(R.id.rl_more_error);</span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultAdapter adapter;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MoreViewHolder</span><span class="params">(DefaultAdapter adapter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.adapter = adapter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getConvertView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        loadMore();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getConvertView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadMore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        adapter.loadMore();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">(Integer integer)</span> </span>&#123;</span><br><span class="line">        rl_more_error.setVisibility(data==LOAD_ERROR?View.VISIBLE:View.GONE);</span><br><span class="line">        rl_more_loading.setVisibility(data==HAS_MORE?View.VISIBLE:View.GONE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultAdapter：</p>
<p>具体的加载更多的,则交给子类去处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.adapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.BaseAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.holder.BaseViewHolder;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.holder.MoreViewHolder;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.manager.ThreadManager;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.UIUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/3.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">Data</span>&gt; <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Data&gt; datas;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultAdapter</span><span class="params">(List&lt;Data&gt; datas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.datas = datas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_ITEM = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MORE_ITEM = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datas.size() + <span class="number">1</span>;<span class="comment">//+1是因为加载更多</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datas.get(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (position == datas.size()) &#123; <span class="comment">// 当前是最后一个条目</span></span><br><span class="line">            <span class="keyword">return</span> MORE_ITEM;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getInnerItemViewType(position); <span class="comment">// 如果不是最后一个条目 返回默认类型</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getInnerItemViewType</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DEFAULT_ITEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getViewTypeCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getViewTypeCount() + <span class="number">1</span>;<span class="comment">//加载更多  2种不同类型</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        BaseViewHolder viewHolder = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (getItemViewType(position)) &#123;</span><br><span class="line">            <span class="keyword">case</span> MORE_ITEM:</span><br><span class="line">                <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    viewHolder = getMoreViewHolder();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    viewHolder = (BaseViewHolder) convertView.getTag();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DEFAULT_ITEM:</span><br><span class="line">                <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    viewHolder = getHolder();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    viewHolder = (BaseViewHolder) convertView.getTag();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (position &lt; datas.size()) &#123;</span><br><span class="line">                    viewHolder.setData(datas.get(position));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> viewHolder.getConvertView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MoreViewHolder holder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> BaseViewHolder <span class="title">getMoreViewHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(holder!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> holder;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            holder=<span class="keyword">new</span> MoreViewHolder(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> holder;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> BaseViewHolder&lt;Data&gt; <span class="title">getHolder</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadMore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadManager.getLongPool().execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> List&lt;Data&gt; newData = onload();</span><br><span class="line">                UIUtils.runInMainThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span>(newData==<span class="keyword">null</span>)&#123;</span><br><span class="line">                            holder.setData(MoreViewHolder.LOAD_ERROR);<span class="comment">//</span></span><br><span class="line">                        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(newData.size()==<span class="number">0</span>)&#123;</span><br><span class="line">                            holder.setData(MoreViewHolder.HAS_NO_MORE);</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            <span class="comment">// 成功了</span></span><br><span class="line">                            holder.setData(MoreViewHolder.HAS_MORE);</span><br><span class="line">                            datas.addAll(newData);<span class="comment">//  给listView之前的集合添加一个新的集合</span></span><br><span class="line">                            notifyDataSetChanged();<span class="comment">// 刷新界面</span></span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 加载更多数据</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span>  <span class="keyword">abstract</span> List&lt;Data&gt; <span class="title">onload</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="加载更多">加载更多</h2><p>加载更多的逻辑在各个应用中逻辑不一致,根据自己需求定义即可。重写onLoad()方法。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> List&lt;AppInfo&gt; <span class="title">onload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       AppProtocol appProtocol = <span class="keyword">new</span> AppProtocol();</span><br><span class="line">       List&lt;AppInfo&gt; appInfoList = appProtocol.load(datas.size());</span><br><span class="line">       datas.addAll(appInfoList);</span><br><span class="line">       <span class="keyword">return</span> appInfoList;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>到现在,实现的效果图如下：<br><img src="http://7xljei.com1.z0.glb.clouddn.com/loadingmore.gif" alt="效果图"></p>
<h1 id="2015-10-05晚上">2015.10.05晚上</h1><p>玩了一天,现在继续。</p>
<h2 id="框架搭建复习">框架搭建复习</h2><p>首先看下面的效果图：</p>
<p><img src="http://7xljei.com1.z0.glb.clouddn.com/framework1005.gif" alt="效果图"></p>
<p>那么在代码实现上,是这样的.</p>
<p>MainActivity:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.myframework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.BaseAdapter;</span><br><span class="line"><span class="keyword">import</span> android.widget.ListView;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ListView listView;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; datas;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        datas = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            datas.add(<span class="string">"duoduo"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        listView = (ListView) findViewById(R.id.list);</span><br><span class="line">        listView.setAdapter(<span class="keyword">new</span> MainAdapter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span></span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>,OtherActivity.class);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MainAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> datas.size();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> datas.get(position);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> position;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">            MainHolder mainHolder;</span><br><span class="line">            <span class="keyword">if</span> (convertView == <span class="keyword">null</span>)&#123;</span><br><span class="line">                convertView = View.inflate(MainActivity.<span class="keyword">this</span>,R.layout.list_item_main,<span class="keyword">null</span>);</span><br><span class="line">                mainHolder = <span class="keyword">new</span> MainHolder();</span><br><span class="line">                mainHolder.textView = (TextView) convertView.findViewById(R.id.textView);</span><br><span class="line">                convertView.setTag(mainHolder);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                mainHolder = (MainHolder) convertView.getTag();</span><br><span class="line">            &#125;</span><br><span class="line">            mainHolder.textView.setText(datas.get(position));</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MainHolder</span></span>&#123;</span><br><span class="line">        TextView textView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OtherActivity:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.myframework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.Drawable;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.BaseAdapter;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"><span class="keyword">import</span> android.widget.ListView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OtherActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ListView listView;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Drawable&gt; datas;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_other);</span><br><span class="line">        listView = (ListView) findViewById(R.id.list);</span><br><span class="line">        datas = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            Drawable drawable = getResources().getDrawable(R.mipmap.ic_launcher);</span><br><span class="line">            datas.add(drawable);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        listView.setAdapter(<span class="keyword">new</span> OtherAdapter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">OtherAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> datas.size();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> datas.get(position);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> position;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">            MainHolder mainHolder;</span><br><span class="line">            <span class="keyword">if</span> (convertView == <span class="keyword">null</span>)&#123;</span><br><span class="line">                convertView = View.inflate(OtherActivity.<span class="keyword">this</span>,R.layout.list_item_other,<span class="keyword">null</span>);</span><br><span class="line">                mainHolder = <span class="keyword">new</span> MainHolder();</span><br><span class="line">                mainHolder.imageView = (ImageView) convertView.findViewById(R.id.imageView);</span><br><span class="line">                convertView.setTag(mainHolder);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                mainHolder = (MainHolder) convertView.getTag();</span><br><span class="line">            &#125;</span><br><span class="line">            mainHolder.imageView.setImageDrawable(datas.get(position));</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MainHolder</span></span>&#123;</span><br><span class="line">        ImageView imageView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Ok,那么现在就对adapter进行抽取。<br>创建DefaultAdapter,并让Activity中的adapter继承自它。</p>
<p>那么在上面的两个adapter当中,实质上adapter的<code>getCount</code>,<code>getItem</code>,<code>getItemId</code>,三个方法是一样的。<br>于是将这三个方法剪切到基类的adapter中。<br>到这里,基类adapter的代码如下：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.myframework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.BaseAdapter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/4.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datas.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datas.get(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>发现没有数据源,所以需要在构造器中将数据传过来,但是两个Activity的数据类型显然不一致,所以这里用泛型代替。</p>
<p>修改后变成这样了：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.myframework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.BaseAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/4.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; datas;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultAdapter</span><span class="params">(List&lt;T&gt; datas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.datas = datas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datas.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datas.get(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ok,那么轮到两个Activity了。传一个具体的参数类型,以及实现构造器.<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainAdapter</span> <span class="keyword">extends</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">String</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainAdapter</span><span class="params">(List&lt;String&gt; datas)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(datas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">            MainHolder mainHolder;</span><br><span class="line">            <span class="keyword">if</span> (convertView == <span class="keyword">null</span>)&#123;</span><br><span class="line">                convertView = View.inflate(MainActivity.<span class="keyword">this</span>,R.layout.list_item_main,<span class="keyword">null</span>);</span><br><span class="line">                mainHolder = <span class="keyword">new</span> MainHolder();</span><br><span class="line">                mainHolder.textView = (TextView) convertView.findViewById(R.id.textView);</span><br><span class="line">                convertView.setTag(mainHolder);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                mainHolder = (MainHolder) convertView.getTag();</span><br><span class="line">            &#125;</span><br><span class="line">            mainHolder.textView.setText(datas.get(position));</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MainHolder</span></span>&#123;</span><br><span class="line">        TextView textView;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>另一个也是如此。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OtherAdapter</span> <span class="keyword">extends</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">Drawable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OtherAdapter</span><span class="params">(List&lt;Drawable&gt; datas)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(datas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">            OtherHolder otherHolder;</span><br><span class="line">            <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                convertView = View.inflate(OtherActivity.<span class="keyword">this</span>, R.layout.list_item_other, <span class="keyword">null</span>);</span><br><span class="line">                otherHolder = <span class="keyword">new</span> OtherHolder();</span><br><span class="line">                otherHolder.imageView = (ImageView) convertView.findViewById(R.id.imageView);</span><br><span class="line">                convertView.setTag(otherHolder);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                otherHolder = (OtherHolder) convertView.getTag();</span><br><span class="line">            &#125;</span><br><span class="line">            otherHolder.imageView.setImageDrawable(datas.get(position));</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">OtherHolder</span> </span>&#123;</span><br><span class="line">        ImageView imageView;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>前三个方法抽取成功后,现在是最后一个方法的抽取,<code>getView</code>,如MainActivity中的这个方法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">           MainHolder mainHolder;</span><br><span class="line">           <span class="keyword">if</span> (convertView == <span class="keyword">null</span>)&#123;</span><br><span class="line">               convertView = View.inflate(MainActivity.<span class="keyword">this</span>,R.layout.list_item_main,<span class="keyword">null</span>);</span><br><span class="line">               mainHolder = <span class="keyword">new</span> MainHolder();</span><br><span class="line">               mainHolder.textView = (TextView) convertView.findViewById(R.id.textView);</span><br><span class="line">               convertView.setTag(mainHolder);</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               mainHolder = (MainHolder) convertView.getTag();</span><br><span class="line">           &#125;</span><br><span class="line">           mainHolder.textView.setText(datas.get(position));</span><br><span class="line">           <span class="keyword">return</span> convertView;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">class</span> <span class="title">MainHolder</span></span>&#123;</span><br><span class="line">       TextView textView;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><code>getView</code>方法和MainHolder之间有个重要的关系。我们可以先这样抽取：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainAdapter</span> <span class="keyword">extends</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainAdapter</span><span class="params">(List&lt;String&gt; datas)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(datas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">            MainHolder mainHolder;</span><br><span class="line">            <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mainHolder = <span class="keyword">new</span> MainHolder();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mainHolder = (MainHolder) convertView.getTag();</span><br><span class="line">            &#125;</span><br><span class="line">            mainHolder.textView.setText(datas.get(position));</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MainHolder</span> </span>&#123;</span><br><span class="line">        TextView textView;</span><br><span class="line">        View convertView;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            convertView = View.inflate(MainActivity.<span class="keyword">this</span>, R.layout.list_item_main, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.textView = (TextView) convertView.findViewById(R.id.textView);</span><br><span class="line">            convertView.setTag(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这一步的抽取应该很好理解。改过后,如下：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainAdapter</span> <span class="keyword">extends</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainAdapter</span><span class="params">(List&lt;String&gt; datas)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(datas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">            MainHolder mainHolder;</span><br><span class="line">            <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mainHolder = <span class="keyword">new</span> MainHolder();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mainHolder = (MainHolder) convertView.getTag();</span><br><span class="line">            &#125;</span><br><span class="line">            String str = datas.get(position);</span><br><span class="line">            mainHolder.setData(str);</span><br><span class="line">            <span class="keyword">return</span> mainHolder.getConvertView();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MainHolder</span> </span>&#123;</span><br><span class="line">        TextView textView;</span><br><span class="line">        View convertView;</span><br><span class="line">        String data;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            convertView = View.inflate(MainActivity.<span class="keyword">this</span>, R.layout.list_item_main, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.textView = (TextView) convertView.findViewById(R.id.textView);</span><br><span class="line">            convertView.setTag(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getConvertView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.data = data;</span><br><span class="line">            refreshView();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.textView.setText(data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>同理：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OtherAdapter</span> <span class="keyword">extends</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">Drawable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OtherAdapter</span><span class="params">(List&lt;Drawable&gt; datas)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(datas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">            OtherHolder otherHolder;</span><br><span class="line">            <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                otherHolder = <span class="keyword">new</span> OtherHolder();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                otherHolder = (OtherHolder) convertView.getTag();</span><br><span class="line">            &#125;</span><br><span class="line">            Drawable drawable = datas.get(position);</span><br><span class="line">            otherHolder.setData(drawable);</span><br><span class="line">            <span class="keyword">return</span> otherHolder.getConvertView();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">OtherHolder</span> </span>&#123;</span><br><span class="line">        ImageView imageView;</span><br><span class="line">        View convertView;</span><br><span class="line">        Drawable data;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OtherHolder</span><span class="params">()</span></span>&#123;</span><br><span class="line">            convertView = View.inflate(OtherActivity.<span class="keyword">this</span>, R.layout.list_item_other, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.imageView = (ImageView) convertView.findViewById(R.id.imageView);</span><br><span class="line">            convertView.setTag(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getConvertView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(Drawable data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.data = data;</span><br><span class="line">            refreshView();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.imageView.setImageDrawable(data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>那么<code>getView</code>方法到这里有就是抽取完毕了。下面观察下两个Holder的代码。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHolder</span> </span>&#123;</span><br><span class="line">        TextView textView;</span><br><span class="line">        View convertView;</span><br><span class="line">        String data;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            convertView = View.inflate(MainActivity.<span class="keyword">this</span>, R.layout.list_item_main, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.textView = (TextView) convertView.findViewById(R.id.textView);</span><br><span class="line">            convertView.setTag(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getConvertView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.data = data;</span><br><span class="line">            refreshView();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.textView.setText(data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>OtherHolder:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OtherHolder</span> </span>&#123;</span><br><span class="line">        ImageView imageView;</span><br><span class="line">        View convertView;</span><br><span class="line">        Drawable data;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OtherHolder</span><span class="params">()</span></span>&#123;</span><br><span class="line">            convertView = View.inflate(OtherActivity.<span class="keyword">this</span>, R.layout.list_item_other, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.imageView = (ImageView) convertView.findViewById(R.id.imageView);</span><br><span class="line">            convertView.setTag(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getConvertView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(Drawable data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.data = data;</span><br><span class="line">            refreshView();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.imageView.setImageDrawable(data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>是不是很像,所以也可以进行抽取。上面的两个holder的代码中,均有构造器,所以在基类中提供一个构造器.<br>在两个holder的构造器中,前面两行所做的就是初始化view的动作。但是不同的类,是不同的,所以在基类holder中,这样去实现.<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.myframework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/5.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> View convertView;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        convertView = initView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> View <span class="title">initView</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MainHolder:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHolder</span> <span class="keyword">extends</span> <span class="title">BaseHolder</span></span>&#123;</span><br><span class="line">        TextView textView;</span><br><span class="line">        View convertView;</span><br><span class="line">        String data;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            convertView = View.inflate(MainActivity.<span class="keyword">this</span>, R.layout.list_item_main, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.textView = (TextView) convertView.findViewById(R.id.textView);</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getConvertView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.data = data;</span><br><span class="line">            refreshView();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.textView.setText(data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>OtherHolder:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OtherHolder</span> <span class="keyword">extends</span> <span class="title">BaseHolder</span></span>&#123;</span><br><span class="line">        ImageView imageView;</span><br><span class="line">        View convertView;</span><br><span class="line">        Drawable data;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            convertView = View.inflate(OtherActivity.<span class="keyword">this</span>, R.layout.list_item_other, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.imageView = (ImageView) convertView.findViewById(R.id.imageView);</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getConvertView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(Drawable data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.data = data;</span><br><span class="line">            refreshView();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.imageView.setImageDrawable(data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>在两个holder中,发现<code>setData()</code>方法仍然可以进行抽取.到最后,是这样的。<br>BaseHolder：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.myframework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/5.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseHolder</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> View convertView;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        convertView = initView();</span><br><span class="line">        convertView.setTag(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        refreshView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getConvertView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> convertView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> View <span class="title">initView</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>MainHolder:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHolder</span> <span class="keyword">extends</span> <span class="title">BaseHolder</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">       TextView textView;</span><br><span class="line">       <span class="annotation">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> View <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           convertView = View.inflate(MainActivity.<span class="keyword">this</span>, R.layout.list_item_main, <span class="keyword">null</span>);</span><br><span class="line">           <span class="keyword">this</span>.textView = (TextView) convertView.findViewById(R.id.textView);</span><br><span class="line">           <span class="keyword">return</span> convertView;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="annotation">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.textView.setText(data);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>OtherHolder:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OtherHolder</span> <span class="keyword">extends</span> <span class="title">BaseHolder</span>&lt;<span class="title">Drawable</span>&gt; </span>&#123;</span><br><span class="line">        ImageView imageView;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            convertView = View.inflate(OtherActivity.<span class="keyword">this</span>, R.layout.list_item_other, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.imageView = (ImageView) convertView.findViewById(R.id.imageView);</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.imageView.setImageDrawable(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>那么进行基类adapter对两个adapter中的<code>getView</code>方法的抽取.</p>
<p>那么,到此为止。整个框架也就完整了.<br>BaseHolder:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.myframework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/5.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseHolder</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> View convertView;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        convertView = initView();</span><br><span class="line">        convertView.setTag(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        refreshView(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getConvertView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> convertView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">(T data)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> View <span class="title">initView</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DefaultAdapter:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.myframework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.BaseAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/4.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; datas;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultAdapter</span><span class="params">(List&lt;T&gt; datas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.datas = datas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datas.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> datas.get(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup parent)</span> </span>&#123;</span><br><span class="line">        BaseHolder mainHolder;</span><br><span class="line">        <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mainHolder = getHolder();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mainHolder = (BaseHolder) convertView.getTag();</span><br><span class="line">        &#125;</span><br><span class="line">        T str = datas.get(position);</span><br><span class="line">        mainHolder.setData(str);</span><br><span class="line">        <span class="keyword">return</span> mainHolder.getConvertView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> BaseHolder <span class="title">getHolder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MainActivity:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.myframework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.ListView;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ListView listView;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; datas;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        datas = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            datas.add(<span class="string">"duoduo"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        listView = (ListView) findViewById(R.id.list);</span><br><span class="line">        listView.setAdapter(<span class="keyword">new</span> MainAdapter(datas));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, OtherActivity.class);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MainAdapter</span> <span class="keyword">extends</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MainAdapter</span><span class="params">(List&lt;String&gt; datas)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(datas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> BaseHolder <span class="title">getHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MainHolder();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MainHolder</span> <span class="keyword">extends</span> <span class="title">BaseHolder</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">        TextView textView;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            convertView = View.inflate(MainActivity.<span class="keyword">this</span>, R.layout.list_item_main, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.textView = (TextView) convertView.findViewById(R.id.textView);</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.textView.setText(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OtherActivity:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.myframework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.Drawable;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"><span class="keyword">import</span> android.widget.ListView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OtherActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ListView listView;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Drawable&gt; datas;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_other);</span><br><span class="line">        listView = (ListView) findViewById(R.id.list);</span><br><span class="line">        datas = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            Drawable drawable = getResources().getDrawable(R.mipmap.ic_launcher);</span><br><span class="line">            datas.add(drawable);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        listView.setAdapter(<span class="keyword">new</span> OtherAdapter(datas));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">OtherAdapter</span> <span class="keyword">extends</span> <span class="title">DefaultAdapter</span>&lt;<span class="title">Drawable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OtherAdapter</span><span class="params">(List&lt;Drawable&gt; datas)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(datas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> BaseHolder <span class="title">getHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> OtherHolder();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">OtherHolder</span> <span class="keyword">extends</span> <span class="title">BaseHolder</span>&lt;<span class="title">Drawable</span>&gt; </span>&#123;</span><br><span class="line">        ImageView imageView;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            convertView = View.inflate(OtherActivity.<span class="keyword">this</span>, R.layout.list_item_other, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.imageView = (ImageView) convertView.findViewById(R.id.imageView);</span><br><span class="line">            <span class="keyword">return</span> convertView;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">(Drawable data)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.imageView.setImageDrawable(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="首页展示图片">首页展示图片</h2><p>首页中有个ViewPager在无线循环轮播广告.这里是实现这个功能。首先找到HomeProtocol:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.protocol;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONException;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.AppInfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/2.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeProtocol</span> <span class="keyword">extends</span> <span class="title">BaseProtocol</span>&lt;<span class="title">List</span>&lt;<span class="title">AppInfo</span>&gt;&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; pictures;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;AppInfo&gt; <span class="title">parserJson</span><span class="params">(String json)</span> </span>&#123;</span><br><span class="line">        List&lt;AppInfo&gt; appInfos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        pictures = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JSONObject jsonObject = <span class="keyword">new</span> JSONObject(json);</span><br><span class="line">            JSONArray picture = jsonObject.getJSONArray(<span class="string">"picture"</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; picture.length(); i++) &#123;</span><br><span class="line">                String string = picture.getString(i);</span><br><span class="line">                pictures.add(string);</span><br><span class="line">            &#125;</span><br><span class="line">            JSONArray jsonArray = jsonObject.getJSONArray(<span class="string">"list"</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jsonArray.length(); i++) &#123;</span><br><span class="line">                JSONObject object = jsonArray.getJSONObject(i);</span><br><span class="line">                <span class="keyword">long</span> id = object.getLong(<span class="string">"id"</span>);</span><br><span class="line">                String name = object.getString(<span class="string">"name"</span>);</span><br><span class="line">                String packageName = object.getString(<span class="string">"packageName"</span>);</span><br><span class="line">                String iconUrl = object.getString(<span class="string">"iconUrl"</span>);</span><br><span class="line">                <span class="keyword">float</span> stars = Float.parseFloat(object.getString(<span class="string">"stars"</span>));</span><br><span class="line">                String downloadUrl = object.getString(<span class="string">"downloadUrl"</span>);</span><br><span class="line">                <span class="keyword">long</span> size = object.getLong(<span class="string">"size"</span>);</span><br><span class="line">                String des = object.getString(<span class="string">"des"</span>);</span><br><span class="line">                AppInfo info = <span class="keyword">new</span> AppInfo(id, name, packageName,</span><br><span class="line">                        iconUrl, stars, downloadUrl, des, size);</span><br><span class="line">                appInfos.add(info);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> appInfos;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getPictures</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pictures;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"home"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再找到HomeFragment:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.fragment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.bitmap.PauseOnScrollListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.adapter.HomeAdapter;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.AppInfo;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.holder.HomePictureHolder;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.protocol.HomeProtocol;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.view.BaseListView;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.view.LoadingPage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/1.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeFragment</span> <span class="keyword">extends</span> <span class="title">BaseFragment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = HomeFragment.class.getSimpleName();</span><br><span class="line"></span><br><span class="line">    List&lt;AppInfo&gt; appInfos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HomeAdapter adapter;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; pictures;<span class="comment">//循环广告</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> View <span class="title">createSuccessView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BaseListView listView = <span class="keyword">new</span> BaseListView(getActivity());</span><br><span class="line"></span><br><span class="line">        HomePictureHolder homePictureHolder = <span class="keyword">new</span> HomePictureHolder();</span><br><span class="line"></span><br><span class="line">        homePictureHolder.setData(pictures);</span><br><span class="line"></span><br><span class="line">        View convertView = homePictureHolder.getConvertView();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*convertView.setLayoutParams(new AbsListView.LayoutParams(</span><br><span class="line">                AbsListView.LayoutParams.MATCH_PARENT,</span><br><span class="line">                AbsListView.LayoutParams.WRAP_CONTENT));*/</span></span><br><span class="line"></span><br><span class="line">        listView.addHeaderView(convertView);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (adapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            adapter = <span class="keyword">new</span> HomeAdapter(appInfos);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        listView.setAdapter(adapter);</span><br><span class="line"></span><br><span class="line">        bitmapUtils.configDefaultLoadFailedImage(R.drawable.ic_default);</span><br><span class="line">        bitmapUtils.configDefaultLoadingImage(R.drawable.ic_default);</span><br><span class="line"></span><br><span class="line">        listView.setOnScrollListener(<span class="keyword">new</span> PauseOnScrollListener</span><br><span class="line">                (bitmapUtils, <span class="keyword">false</span>, <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> listView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> LoadingPage.<span class="function">LoadResult <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HomeProtocol protocol = <span class="keyword">new</span> HomeProtocol();</span><br><span class="line">        appInfos = protocol.load(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">/*for (AppInfo info :</span><br><span class="line">                appInfos) &#123;</span><br><span class="line">            System.out.println(info.toString());</span><br><span class="line"></span><br><span class="line">        &#125;*/</span></span><br><span class="line"></span><br><span class="line">        pictures = protocol.getPictures();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> checkData(appInfos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">        show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后基于holder编程：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.holder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.support.v4.view.PagerAdapter;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.view.ViewPager;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.AbsListView;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.BitmapUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.http.HttpHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.BitmapHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.UIUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/5.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomePictureHolder</span> <span class="keyword">extends</span> <span class="title">BaseViewHolder</span>&lt;<span class="title">List</span>&lt;<span class="title">String</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = HomePictureHolder.class.getSimpleName();</span><br><span class="line">    <span class="keyword">private</span> ViewPager viewPager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; datas;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        viewPager = <span class="keyword">new</span> ViewPager(UIUtils.getContext());</span><br><span class="line">        viewPager.setLayoutParams(<span class="keyword">new</span> AbsListView.LayoutParams(</span><br><span class="line">                AbsListView.LayoutParams.MATCH_PARENT, UIUtils</span><br><span class="line">                .getDimens(R.dimen.home_picture_height)));</span><br><span class="line">        <span class="keyword">return</span> viewPager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">(List&lt;String&gt; datas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.datas = datas;</span><br><span class="line">        viewPager.setAdapter(<span class="keyword">new</span> HomePictureAdapter());</span><br><span class="line">        viewPager.setCurrentItem(<span class="number">1000</span> * datas.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">HomePictureAdapter</span> <span class="keyword">extends</span> <span class="title">PagerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//优化   不必没次都去创建ImageView</span></span><br><span class="line">        LinkedList&lt;ImageView&gt; convertView = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.MAX_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isViewFromObject</span><span class="params">(View view, Object object)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> view == object;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">instantiateItem</span><span class="params">(ViewGroup container, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> index = position % datas.size();</span><br><span class="line">            ImageView imageView;</span><br><span class="line">            <span class="keyword">if</span> (convertView.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                imageView = convertView.remove(<span class="number">0</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"instantiateItem "</span> + <span class="string">"不必创建"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                imageView = <span class="keyword">new</span> ImageView(UIUtils.getContext());</span><br><span class="line">                Log.e(TAG, <span class="string">"instantiateItem "</span> + <span class="string">"必须创建"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            BitmapUtils bitmapUtils = BitmapHelper.getInstance();</span><br><span class="line">            bitmapUtils.display(imageView, HttpHelper.URL + <span class="string">"image?name="</span> + datas.get(index));</span><br><span class="line">            container.addView(imageView);</span><br><span class="line">            <span class="keyword">return</span> imageView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyItem</span><span class="params">(ViewGroup container, <span class="keyword">int</span> position, Object object)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//super.destroyItem(container, position, object);</span></span><br><span class="line">            ImageView view = (ImageView) object;</span><br><span class="line">            convertView.add(view);</span><br><span class="line">            container.removeView(view);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里需要注意的是ViewPager的一点优化。</p>
<h2 id="轮播图的无线循环">轮播图的无线循环</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.holder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.support.v4.view.PagerAdapter;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.view.ViewPager;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.MotionEvent;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.AbsListView;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"><span class="keyword">import</span> android.widget.RelativeLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lidroid.xutils.BitmapUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.R;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.http.HttpHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.BitmapHelper;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.utils.UIUtils;</span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.view.IndicatorView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/5.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomePictureHolder</span> <span class="keyword">extends</span> <span class="title">BaseViewHolder</span>&lt;<span class="title">List</span>&lt;<span class="title">String</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = HomePictureHolder.class.getSimpleName();</span><br><span class="line">    <span class="keyword">private</span> ViewPager viewPager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; datas;</span><br><span class="line">    <span class="keyword">private</span> AutoRunTask autoRunTask;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RelativeLayout.LayoutParams rl;</span><br><span class="line">    <span class="keyword">private</span> IndicatorView indicatorView;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 初始化头。由于使用相对布局方便放置可以跳动的点</span></span><br><span class="line">        RelativeLayout mHeadView = <span class="keyword">new</span> RelativeLayout(UIUtils.getContext());</span><br><span class="line">        <span class="comment">// 设置轮播图的宽和高</span></span><br><span class="line">        AbsListView.LayoutParams params = <span class="keyword">new</span> AbsListView.LayoutParams(</span><br><span class="line">                AbsListView.LayoutParams.MATCH_PARENT,</span><br><span class="line">                UIUtils.getDimens(R.dimen.list_header_hight));</span><br><span class="line"></span><br><span class="line">        mHeadView.setLayoutParams(params);</span><br><span class="line">        <span class="comment">// 初始化轮播图</span></span><br><span class="line"></span><br><span class="line">        viewPager = <span class="keyword">new</span> ViewPager(UIUtils.getContext());</span><br><span class="line">        <span class="comment">// 初始化轮播图的宽和高</span></span><br><span class="line"></span><br><span class="line">        rl = <span class="keyword">new</span> RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.MATCH_PARENT,</span><br><span class="line">                RelativeLayout.LayoutParams.MATCH_PARENT);</span><br><span class="line"></span><br><span class="line">        viewPager.setLayoutParams(rl);</span><br><span class="line"></span><br><span class="line">        HomePictureAdapter adapter = <span class="keyword">new</span> HomePictureAdapter();</span><br><span class="line"></span><br><span class="line">        viewPager.setAdapter(adapter);</span><br><span class="line">        <span class="comment">// 初始化点</span></span><br><span class="line"></span><br><span class="line">        indicatorView = <span class="keyword">new</span> IndicatorView(UIUtils.getContext());</span><br><span class="line"></span><br><span class="line">        rl = <span class="keyword">new</span> RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.WRAP_CONTENT,</span><br><span class="line">                RelativeLayout.LayoutParams.WRAP_CONTENT);</span><br><span class="line">        <span class="comment">// 设置到屏幕的下边</span></span><br><span class="line">        rl.addRule(mHeadView.ALIGN_PARENT_BOTTOM);</span><br><span class="line">        rl.addRule(mHeadView.ALIGN_PARENT_RIGHT);</span><br><span class="line">        <span class="comment">// 设置点的背景图片</span></span><br><span class="line">        indicatorView.setIndicatorDrawable(UIUtils</span><br><span class="line">                .getDrawable(R.drawable.indicator));</span><br><span class="line">        <span class="comment">// 设置点的间距</span></span><br><span class="line">        rl.setMargins(<span class="number">0</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">20</span>);</span><br><span class="line">        indicatorView.setLayoutParams(rl);</span><br><span class="line"></span><br><span class="line">        indicatorView.setSelection(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 把点和轮播图添加到头里面去</span></span><br><span class="line">        mHeadView.addView(viewPager);</span><br><span class="line"></span><br><span class="line">        mHeadView.addView(indicatorView);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mHeadView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshView</span><span class="params">(<span class="keyword">final</span> List&lt;String&gt; datas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.datas = datas;</span><br><span class="line">        viewPager.setAdapter(<span class="keyword">new</span> HomePictureAdapter());</span><br><span class="line">        viewPager.setCurrentItem(<span class="number">1000</span> * datas.size());</span><br><span class="line">        viewPager.setOnTouchListener(<span class="keyword">new</span> View.OnTouchListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouch</span><span class="params">(View v, MotionEvent event)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span> (event.getAction()) &#123;</span><br><span class="line">                    <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                        autoRunTask.stop();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//此处是修改bug。</span></span><br><span class="line">                    <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">                        autoRunTask.start();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">                        autoRunTask.start();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//此处不能返回true</span></span><br><span class="line">                <span class="comment">//ViewPager触摸事件返回false</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        viewPager.addOnPageChangeListener(<span class="keyword">new</span> ViewPager.OnPageChangeListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageScrolled</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">float</span> positionOffset, <span class="keyword">int</span> positionOffsetPixels)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageSelected</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">                indicatorView.setSelection(position % datas.size());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageScrollStateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        indicatorView.setCount(data.size());</span><br><span class="line"></span><br><span class="line">        autoRunTask = <span class="keyword">new</span> AutoRunTask();</span><br><span class="line">        autoRunTask.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> flag;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">AutoRunTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                UIUtils.removeCallbacks(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">int</span> currentItem = viewPager.getCurrentItem();</span><br><span class="line">                currentItem++;</span><br><span class="line">                viewPager.setCurrentItem(currentItem);</span><br><span class="line">                UIUtils.postDelayed(<span class="keyword">this</span>, <span class="number">1500</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                UIUtils.removeCallbacks(<span class="keyword">this</span>);</span><br><span class="line">                flag = <span class="keyword">true</span>;</span><br><span class="line">                UIUtils.postDelayed(<span class="keyword">this</span>, <span class="number">1500</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                flag = <span class="keyword">false</span>;</span><br><span class="line">                UIUtils.removeCallbacks(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">HomePictureAdapter</span> <span class="keyword">extends</span> <span class="title">PagerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//优化   不必没次都去创建ImageView</span></span><br><span class="line">        LinkedList&lt;ImageView&gt; convertView = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.MAX_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isViewFromObject</span><span class="params">(View view, Object object)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> view == object;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">instantiateItem</span><span class="params">(ViewGroup container, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> index = position % datas.size();</span><br><span class="line">            ImageView imageView;</span><br><span class="line">            <span class="keyword">if</span> (convertView.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                imageView = convertView.remove(<span class="number">0</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">"instantiateItem "</span> + <span class="string">"不必创建"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                imageView = <span class="keyword">new</span> ImageView(UIUtils.getContext());</span><br><span class="line">                Log.e(TAG, <span class="string">"instantiateItem "</span> + <span class="string">"必须创建"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            BitmapUtils bitmapUtils = BitmapHelper.getInstance();</span><br><span class="line">            bitmapUtils.display(imageView, HttpHelper.URL + <span class="string">"image?name="</span> + datas.get(index));</span><br><span class="line">            container.addView(imageView);</span><br><span class="line">            <span class="keyword">return</span> imageView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyItem</span><span class="params">(ViewGroup container, <span class="keyword">int</span> position, Object object)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//super.destroyItem(container, position, object);</span></span><br><span class="line">            ImageView view = (ImageView) object;</span><br><span class="line">            convertView.add(view);</span><br><span class="line">            container.removeView(view);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处还是有几处需要注意的。<br>实现的效果图如下：</p>
<p><img src="http://7xljei.com1.z0.glb.clouddn.com/circleimageview1005.gif" alt="效果图"></p>
<h2 id="条目点击事件">条目点击事件</h2><p>条目点击事件实质上很简单,但是因为在HomeFragment上,ListView有个HeadView是ViewPager,会导致ListView的条目的<br>position不是按照原来的样子了.在基类的adapter中：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(AdapterView&lt;?&gt; parent, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取顶部条目的数量</span></span><br><span class="line">        <span class="keyword">int</span> headerViewsCount = listView.getHeaderViewsCount();</span><br><span class="line">        position = position - headerViewsCount;</span><br><span class="line">        <span class="comment">//Toast.makeText(UIUtils.getContext(),"position:" + position,Toast.LENGTH_SHORT).show();</span></span><br><span class="line">        onInnerItemClick(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 该方法去处理条目点击事件</span><br><span class="line">     * <span class="doctag">@param</span> position</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInnerItemClick</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>此处需要留意这个api:<br><code>getHeaderViewsCount()</code>.</p>
<p>其他不多说。</p>
<h2 id="DetailActivity数据解析">DetailActivity数据解析</h2><p>数据的json格式如下：<br><img src="http://7xljei.com1.z0.glb.clouddn.com/微信截图_20151005225006.png" alt="数据的json格式"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> me.chenfuduo.mymarketpro.protocol;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> me.chenfuduo.mymarketpro.bean.AppInfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by chenfuduo on 2015/10/5.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DetailProtocol</span> <span class="keyword">extends</span> <span class="title">BaseProtocol</span>&lt;<span class="title">AppInfo</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    String packageName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DetailProtocol</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.packageName = packageName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AppInfo <span class="title">parserJson</span><span class="params">(String json)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JSONObject object = <span class="keyword">new</span> JSONObject(json);</span><br><span class="line">            <span class="keyword">long</span> id = object.getLong(<span class="string">"id"</span>);</span><br><span class="line">            String name = object.getString(<span class="string">"name"</span>);</span><br><span class="line">            String packageName = object.getString(<span class="string">"packageName"</span>);</span><br><span class="line">            String iconUrl = object.getString(<span class="string">"iconUrl"</span>);</span><br><span class="line">            <span class="keyword">float</span> stars = Float.parseFloat(object.getString(<span class="string">"stars"</span>));</span><br><span class="line">            <span class="keyword">long</span> size = object.getLong(<span class="string">"size"</span>);</span><br><span class="line">            String downloadUrl = object.getString(<span class="string">"downloadUrl"</span>);</span><br><span class="line">            String des = object.getString(<span class="string">"des"</span>);</span><br><span class="line">            String downloadNum = object.getString(<span class="string">"downloadNum"</span>);</span><br><span class="line">            String version = object.getString(<span class="string">"version"</span>);</span><br><span class="line">            String date = object.getString(<span class="string">"date"</span>);</span><br><span class="line">            String author = object.getString(<span class="string">"author"</span>);</span><br><span class="line">            List&lt;String&gt; screen = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            JSONArray screenArray = object.getJSONArray(<span class="string">"screen"</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; screenArray.length(); i++) &#123;</span><br><span class="line">                screen.add(screenArray.getString(i));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;String&gt; safeUrl = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            List&lt;String&gt; safeDesUrl = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            List&lt;String&gt; safeDes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            List&lt;Integer&gt; safeDesColor = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            JSONArray jsonArray = object.getJSONArray(<span class="string">"safe"</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jsonArray.length(); i++) &#123;</span><br><span class="line">                JSONObject jsonObject = jsonArray.getJSONObject(i);</span><br><span class="line">                safeUrl.add(jsonObject.getString(<span class="string">"safeUrl"</span>));</span><br><span class="line">                safeDesUrl.add(jsonObject.getString(<span class="string">"safeDesUrl"</span>));</span><br><span class="line">                safeDes.add(jsonObject.getString(<span class="string">"safeDes"</span>));</span><br><span class="line">                safeDesColor.add(jsonObject.getInt(<span class="string">"safeDesColor"</span>));</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            AppInfo appInfo = <span class="keyword">new</span> AppInfo(id, name, packageName, iconUrl,</span><br><span class="line">                    stars, size, downloadUrl, des, downloadNum, version, date,</span><br><span class="line">                    author, screen, safeUrl, safeDesUrl, safeDes, safeDesColor);</span><br><span class="line">            <span class="keyword">return</span> appInfo;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"detail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getParames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&amp;packageName="</span> + packageName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此为止。整个的效果图如下：<br><img src="http://7xljei.com1.z0.glb.clouddn.com/circleimageview1005.gif" alt="效果图"></p>
<p>待续。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/移动开发/">移动开发</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/移动开发/">移动开发</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://chenfuduo.me/2015/10/03/项目框架练习/" data-title="项目框架练习 | louis.chen" data-tsina="2338582935" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2015/09/30/无缝循环广告位的实现/"  title="无缝循环广告位的实现">
 <strong>下一篇：</strong><br/> 
 <span>无缝循环广告位的实现
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2015/10/03/项目框架练习/" data-title="项目框架练习" data-url="http://chenfuduo.me/2015/10/03/项目框架练习/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-01上午"><span class="toc-number">1.</span> <span class="toc-text">2015.10.01上午</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境搭建"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ActionBar的显示"><span class="toc-number">1.2.</span> <span class="toc-text">ActionBar的显示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ActionBar的搜索功能"><span class="toc-number">1.3.</span> <span class="toc-text">ActionBar的搜索功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ActionBar的返回功能"><span class="toc-number">1.4.</span> <span class="toc-text">ActionBar的返回功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TabLayout,DrawerLayout,NavigationView,Toolbar搭建程序主界面"><span class="toc-number">1.5.</span> <span class="toc-text">TabLayout,DrawerLayout,NavigationView,Toolbar搭建程序主界面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-01晚上"><span class="toc-number">2.</span> <span class="toc-text">2015.10.01晚上</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#主界面"><span class="toc-number">2.1.</span> <span class="toc-text">主界面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#抽取BaseActivity"><span class="toc-number">2.2.</span> <span class="toc-text">抽取BaseActivity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FragmentFactory"><span class="toc-number">2.3.</span> <span class="toc-text">FragmentFactory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#广播退出Activity"><span class="toc-number">2.4.</span> <span class="toc-text">广播退出Activity</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-02上午"><span class="toc-number">3.</span> <span class="toc-text">2015.10.02上午</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#显示界面的架子"><span class="toc-number">3.1.</span> <span class="toc-text">显示界面的架子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五种状态"><span class="toc-number">3.2.</span> <span class="toc-text">五种状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#复用FrameLayout的问题"><span class="toc-number">3.3.</span> <span class="toc-text">复用FrameLayout的问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-02下午"><span class="toc-number">4.</span> <span class="toc-text">2015.10.02下午</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#抽取到BaseFragment中"><span class="toc-number">4.1.</span> <span class="toc-text">抽取到BaseFragment中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#抽取到LoadingPage"><span class="toc-number">4.2.</span> <span class="toc-text">抽取到LoadingPage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#线程池原理"><span class="toc-number">4.3.</span> <span class="toc-text">线程池原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-02晚上"><span class="toc-number">5.</span> <span class="toc-text">2015.10.02晚上</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#请求服务器的框架"><span class="toc-number">5.1.</span> <span class="toc-text">请求服务器的框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#xUtils网络请求导致的错误"><span class="toc-number">5.2.</span> <span class="toc-text">xUtils网络请求导致的错误</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#联网请求数据"><span class="toc-number">5.3.</span> <span class="toc-text">联网请求数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#保存缓存到本地"><span class="toc-number">5.4.</span> <span class="toc-text">保存缓存到本地</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#读取本地缓存"><span class="toc-number">5.5.</span> <span class="toc-text">读取本地缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#json解析"><span class="toc-number">5.6.</span> <span class="toc-text">json解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#布局的搭建"><span class="toc-number">5.7.</span> <span class="toc-text">布局的搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载界面"><span class="toc-number">5.8.</span> <span class="toc-text">加载界面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-03上午"><span class="toc-number">6.</span> <span class="toc-text">2015.10.03上午</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#抽取BaseProtocol"><span class="toc-number">6.1.</span> <span class="toc-text">抽取BaseProtocol</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#专题界面完成"><span class="toc-number">6.2.</span> <span class="toc-text">专题界面完成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BaseListView"><span class="toc-number">6.3.</span> <span class="toc-text">BaseListView</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-03下午"><span class="toc-number">7.</span> <span class="toc-text">2015.10.03下午</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#抽取Adapter和ViewHolder"><span class="toc-number">7.1.</span> <span class="toc-text">抽取Adapter和ViewHolder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#游戏和应用界面"><span class="toc-number">7.2.</span> <span class="toc-text">游戏和应用界面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-03晚上"><span class="toc-number">8.</span> <span class="toc-text">2015.10.03晚上</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MoreViewHolder(加载更多)"><span class="toc-number">8.1.</span> <span class="toc-text">MoreViewHolder(加载更多)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ListView多类型复用"><span class="toc-number">8.2.</span> <span class="toc-text">ListView多类型复用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载更多的业务逻辑"><span class="toc-number">8.3.</span> <span class="toc-text">加载更多的业务逻辑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载更多"><span class="toc-number">8.4.</span> <span class="toc-text">加载更多</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2015-10-05晚上"><span class="toc-number">9.</span> <span class="toc-text">2015.10.05晚上</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#框架搭建复习"><span class="toc-number">9.1.</span> <span class="toc-text">框架搭建复习</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#首页展示图片"><span class="toc-number">9.2.</span> <span class="toc-text">首页展示图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#轮播图的无线循环"><span class="toc-number">9.3.</span> <span class="toc-text">轮播图的无线循环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#条目点击事件"><span class="toc-number">9.4.</span> <span class="toc-text">条目点击事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DetailActivity数据解析"><span class="toc-number">9.5.</span> <span class="toc-text">DetailActivity数据解析</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/收藏/" title="收藏">收藏<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/移动开发/" title="移动开发">移动开发<sup>57</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>2</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/移动开发/" title="移动开发">移动开发<sup>57</sup></a></li>
			
		
			
				<li><a href="/tags/自定义View/" title="自定义View">自定义View<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/UI-UE/" title="UI/UE">UI/UE<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Design-Support-Library/" title="Design Support Library">Design Support Library<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/算法/" title="算法">算法<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/自定义控件/" title="自定义控件">自定义控件<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/ViewDragHelper/" title="ViewDragHelper">ViewDragHelper<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/收藏/" title="收藏">收藏<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/EventBus/" title="EventBus">EventBus<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Bundle/" title="Bundle">Bundle<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://www.vogella.com/tutorials/android.html" target="_blank" title="Vogella">Vogella</a>
            
          </li>
        
    </ul>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=2338582935&verifier=59b78413&dpc=1"></iframe>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> louis.chen,student of USTC,Focus on mobile develop. <br/>
			It is my amibition to make beautiful apps.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2338582935" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/leerduo" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="/about" target="_blank" title="louis.chen">louis.chen</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          c.click();
        }
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"chenlouis"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F63c029dba1e367df2c8ffa39a309056a' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
